<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Appraisal Form</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-new.css">
    <link rel="stylesheet" href="style-popup-forms.css">
    <link rel="icon" href="icons/company/favicon.ico" type="image/x-icon">

    <style>
        .box-wrapper {
            background-color: #f2f2f2;
            margin: 2rem auto;
            max-width: 80rem;
            border-radius: 1rem;
        }


        #AppraisalForm {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Creates 2 equal columns */
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Creates 2 equal columns */
        }


        /* Adjust for smaller screens (mobile) */
        @media (max-width: 768px) {
            #AppraisalForm {
                grid-template-columns: 1fr;
                /* Changes to single column on mobile */
            }
        }
    </style>



</head>

<body>

    <!-- Header -->
    <div id="header-contact-container"></div>
    <div id="header-container"></div>
    <div id="header-banner-container"></div>



    <div id="valueMyCar" class="box-wrapper">
        <form id="AppraisalForm" name="appraisal" method="post" action="/simple-appraisal/simple-appraisal" class="form">
            <div class="alert alert-danger" style="display: none"></div>

            <input type="hidden" name="access_key" value="fc184b2a-7c0d-4071-a665-e807c3f4e679" />
            <input type="hidden" name="subject" value="Value my car ADD CAR REFRENCE" />



            <div id="contact-details-container" class="form-column">
                <span class="title h3">Datos de contacto</span>
                <div class="input-box">
                    <input type="text" id="appraisal_name" placeholder="Nombre *" aria-required="true" maxlength="30"
                        autocapitalize="none" autocorrect="off" name="appraisal[name]" required>
                    <span for="appraisal_name">Nombre *</span>
                </div>
                <div class="input-box">
                    <input type="email" id="appraisal_email" placeholder="Correo electrónico *" aria-required="true"
                        maxlength="30" autocapitalize="none" autocorrect="off" name="appraisal[email]" required>
                    <span for="appraisal_email">Correo electrónico *</span>
                </div>
                <div class="input-box">
                    <input type="tel" id="appraisal_phone" placeholder="Teléfono *" aria-required="true" maxlength="9"
                        autocapitalize="none" autocorrect="off" name="appraisal[phone]" inputmode="numeric"
                        pattern="[0-9]*" title="Por favor, ingresa un número de teléfono válido (solo números)"
                        required>
                    <span for="appraisal_phone">Teléfono *</span>
                </div>
                <div class="input-box">
                    <label id="appraisal_char_count" for="appraisal_comments" class="form-label b1 font-book">Comentarios sobre la
                        financiación (máx. 350 caracteres)</label>
                    <textarea id="appraisal_comments" name="appraisal[comments]" class="form-textarea"
                        placeholder="Tus comentarios" rows="4" maxlength="350"></textarea>
                </div>
            </div>


            <div id="car-details-container" class="form-column">
                <span class="title h3">Información del vehículo</span>
                <div class="input-box">
                    <select id="appraisal_make" name="appraisal[make]" required></select>
                    <span for="appraisal_make">Marca *</span>
                </div>
                <div class="input-row">
                    <div class="input-box">
                        <select id="appraisal_model" name=appraisal[model]" required></select>
                    <span for="appraisal_model">Modelo *</span>
                    

                    </div>
                    <div class="input-box">
                        <input type="text" id="appraisal_version" placeholder="Versión *" aria-required="true"
                            maxlength="30" autocapitalize="none" autocorrect="off" name="appraisal[version]" required>
                        <span for="name">Versión *</span>
                    </div>
                </div>



                <div class="input-row">
                    <div class="input-box">
                        <select id="appraisal_year" name="appraisal[year]" required></select>
                        <span for="appraisal_year">Año *</span>
                    </div>
                    <div class="input-box">
                        <select id="appraisal_mileage" name="appraisal[mileage]" required></select>
                        <span for="appraisal_mileage">Kilometraje *</span>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-box">
                        <select id="appraisal_fuel" name="appraisal[fuel]" required></select>
                        <span for="appraisal_fuel">Combustible *</span>
                    </div>
                    <div class="input-box">
                        <select id="appraisal_transmission" name="appraisal[transmission]" required></select>
                        <span for="appraisal_transmission">Cambio *</span>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-box">
                        <select id="appraisal_bodystyle" name="appraisal[bodystyle]" required></select>
                        <span for="appraisal_bodystyle">Carrocería *</span>
                    </div>
                    <div class="input-box">
                        <select id="appraisal_color" name="appraisal[color]" required></select>
                        <span for="appraisal_color">Color *</span>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-box">
                        <label for="appraisal_cambio?" class="form-label">¿Desea un vehículo a cambio?</label>
                        <div class="form-options">
                            <input type="radio" id="yes" name="appraisal_cambio?" value="Yes" required="">
                            <label for="yes" class="button-like">Sí cambio</label>

                            <input type="radio" id="no" name="appraisal_cambio?" value="No" required="">
                            <label for="no" class="button-like">No cambio</label>
                        </div>
                    </div>
                    <div class="input-box">
                        <input type="text" id="appraisal_model_desired" placeholder="¿Qué tipo de vehículo desea?"
                            aria-required="true" maxlength="30" autocapitalize="none" autocorrect="off"
                            name="appraisal[model_desired]" required>
                        <span for="appraisal_model_desired">¿Qué tipo de vehículo desea?</span>
                    </div>
                </div>
            </div>

            <div class="contact-intro">
                <div class="form-check form-check--required">
                    <input type="checkbox" id="vehicle_send_to_friend_legal_policy_accept"
                        name="vehicle_send_to_friend[legal][policy_accept]" required class="form-check-input" value="1">
                    <label for="vehicle_send_to_friend_legal_policy_accept" class="required">
                        Acepto la <a href="/privacy-policy.html" target="_blank" class="blue-link">política de
                            privacidad</a>.
                    </label>
                </div>
                <div class="form-check form-check--optional">
                    <input type="checkbox" id="ads_accept" name="ads_accept" class="form-check-input" value="1">
                    <label for="ads_accept">
                        Acepto recibir ofertas y promociones de Martínez De Lugo, S.L.U.
                    </label>
                </div>
            </div>

            <div class="form-group">
                <input type="hidden" id="appraisal_vehicle" name="appraisal[vehicle]" value="6272">
            </div>

            <span class="button-box">
                <button class="form-submit-button" type="submit" name="submit" disabled>Enviar</button>
            </span>

            <div class="result-message" id="result"></div>
        </form>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

</body>

<script type="module">
    import { loadHeaderAndFooter } from './js/pageSetup.js';



    
    import { fetchResource } from './js/httpUtils.js';  // Update the import path and function names

    const FORM_DROPDOWN_OPTIONS = 'data/appraisalOptions.json';

    // Function to update character count
    function updateCharCount(textarea, charCountElement, maxLength) {
        const remaining = maxLength - textarea.value.length;
        charCountElement.textContent = `${charCountElement.getAttribute('for')} (${remaining} caracteres restantes)`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadHeaderAndFooter(); // Load header and footer asynchronously
            

        







        initializeDropdown();

        // Add event listeners to form submission
        const form = document.getElementById('AppraisalForm');
        form.addEventListener('submit', handleFormSubmission);

        // Add input listeners to enable/disable the submit button
        addInputListeners(form);

        // Check if elements exist before adding event listeners for dynamic text updates
        const appraisalTextarea = document.getElementById('appraisal_comments');
        const appraisalCharCount = document.getElementById('appraisal_char_count');

        if (appraisalTextarea && appraisalCharCount) {
            appraisalTextarea.addEventListener('input', () => updateCharCount(appraisalTextarea, appraisalCharCount, 350));
        }
    });

    /**
     * Populates a dropdown with options.
     * @param {HTMLSelectElement} dropdown - The dropdown element to populate.
     * @param {Array<string>} values - The list of values to use for the options.
     */
    function populateDropdown(dropdown, values, placeholder) {
        dropdown.innerHTML = `<option value="" selected disabled>${placeholder}</option>` +
            values.map(value =>
                `<option value="${value}">${value}</option>`
            ).join('');
    }

    // Function to check if all required fields in the form are filled out
    function checkFormValidity(form) {
        const requiredInputs = form.querySelectorAll('input[required], textarea[required]');
        const radioGroups = Array.from(requiredInputs)
            .filter(input => input.type === 'radio')
            .map(input => input.name);

        const allInputsFilled = Array.from(requiredInputs).every(input => input.value.trim() !== '');
        const allRadioSelected = radioGroups.every(name => form.querySelector(`input[name="${name}"]:checked`));

        const submitButton = form.querySelector('.form-submit-button');
        if (submitButton) {
            submitButton.disabled = !(allInputsFilled && allRadioSelected);
        }
    }

    // Function to check if an input field has content
    function checkInputHasContent(input) {
        input.classList.toggle('input-has-content', input.value.trim() !== '');
    }

    // Event listener to monitor input changes and update input styles
    function addInputListeners(form) {
        form.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('input', () => {
                checkInputHasContent(input);
                checkFormValidity(form);
            });
            input.addEventListener('change', () => checkFormValidity(form));
        });
    }

// Add this function to fetch and populate the model dropdown based on selected make
async function updateModelDropdown(selectedMake) {
    try {
        const response = await fetch('data/appraisalModels.json'); // Correct path to your JSON file
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
        }
        const data = await response.json();
        
        const models = data[selectedMake] || []; // Get models for the selected make
        const modelDropdown = document.getElementById('appraisal_model'); // Your model dropdown ID
        
        populateDropdown(modelDropdown, models, 'Modelo *'); // Populate with models
    } catch (error) {
        console.error('Error updating model dropdown:', error);
    }
}

// Add this in your initializeDropdown function to set up event listener for the make dropdown
async function initializeDropdown() {
    try {
        const response = await fetch('data/appraisalOptions.json'); // Correct path to your JSON file
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
        }
        const data = await response.json();

        const makeDropdown = document.getElementById('appraisal_make');
        const yearDropdown = document.getElementById('appraisal_year');
        const mileageDropdown = document.getElementById('appraisal_mileage');
        const transmissionDropdown = document.getElementById('appraisal_transmission');
        const fuelDropdown = document.getElementById('appraisal_fuel');
        const bodystyleDropdown = document.getElementById('appraisal_bodystyle');
        const colorDropdown = document.getElementById('appraisal_color');

        populateDropdown(makeDropdown, data.make, 'Marca *');
        populateDropdown(yearDropdown, data.year, 'Año *');
        populateDropdown(mileageDropdown, data.mileage, 'Kilometraje *');
        populateDropdown(transmissionDropdown, data.transmission, 'Cambio *');
        populateDropdown(fuelDropdown, data.fuel, 'Combustible *');
        populateDropdown(bodystyleDropdown, data.bodystyle, 'Carrocería *');
        populateDropdown(colorDropdown, data.color, 'Color *');

        // Set up event listener for make dropdown change
        makeDropdown.addEventListener('change', (event) => {
            const selectedMake = event.target.value;
            updateModelDropdown(selectedMake); // Update the model dropdown
        });

    } catch (error) {
        console.error('Error initializing dropdown:', error);
    }
}

    // Function to handle form submission
    async function handleFormSubmission(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        // Extract contact details from form data
        const name = formData.get('appraisal[name]');
        const email = formData.get('appraisal[email]');
        const phone = formData.get('appraisal[phone]');
        const comments = formData.get('appraisal[comments]');
        // Extract car details from form data
        const make = formData.get('appraisal[make]');
        const model = formData.get('appraisal[model]');
        const version = formData.get('appraisal[version]');
        const year = formData.get('appraisal[year]');
        const mileage = formData.get('appraisal[mileage]');
        const fuel = formData.get('appraisal[fuel]');
        const transmission = formData.get('appraisal[transmission]');
        const bodystyle = formData.get('appraisal[bodystyle]');
        const color = formData.get('appraisal[color]');

        // Capture the value of the "Desea un vehículo a cambio?" radio buttons
        const vehicleExchange = formData.get('appraisal_cambio?');

        // Capture the type of vehicle desired, if applicable
        const desiredVehicleType = vehicleExchange === 'Yes' ? formData.get('appraisal[model_desired]') : '';

        // Prepare the data to send
        const data = {
            access_key: formData.get('access_key'),
            subject: formData.get('subject'),
            from_name: formData.get('from_name'),
            message: `
                **Datos de contacto**
                - Nombre: ${name}
                - Correo electrónico: ${email}
                - Teléfono: ${phone}
                - Comentarios: ${comments}

                **Datos de coche**
                - Marca: ${make}
                - Modelo: ${model}
                - Versión: ${version}
                - Año: ${year}
                - Kilometraje: ${mileage}
                - Combustible: ${fuel}
                - Cambio: ${transmission}
                - Carrocería: ${bodystyle}
                - Color: ${color}
                - Vehicle Exchange: ${vehicleExchange}
                - Desired Vehicle Type: ${desiredVehicleType}
            `
        };

        const submitButton = form.querySelector('.form-submit-button');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            submitButton.style.backgroundColor = '#007bff'; // Change to your desired color for submitting state
        }

        try {
            const response = await fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const json = await response.json();
            if (response.ok) {
                if (submitButton) {
                    submitButton.textContent = '¡Enviado!';
                    submitButton.style.backgroundColor = '#28a745'; // Green color for success
                }
                setTimeout(() => window.history.back(), 2000);
            } else {
                if (submitButton) {
                    submitButton.textContent = `La presentación falló: ${json.message}`;
                    submitButton.style.backgroundColor = '#dc3545'; // Red color for error
                }
                setTimeout(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Enviar';
                        submitButton.style.backgroundColor = ''; // Reset to original color
                    }
                }, 2000);
            }
        } catch (error) {
            console.error('Form submission error:', error); // Log the error
            if (submitButton) {
                submitButton.textContent = '¡Algo salió mal!';
                submitButton.style.backgroundColor = '#dc3545'; // Red color for error
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar';
                    submitButton.style.backgroundColor = ''; // Reset to original color
                }, 2000);
            }
        }
    }

</script>

</html>