<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Reviews Raw</title>
    <style>
        .companyReviewsContainer {
            width: 100%;
            background: #111;
            color: #FFF;
            display: flex;
            padding: 5rem;
            box-sizing: border-box; /* Include padding in width calculations */
        }

        .google-left-column {
            width: 60%;
            padding-right: 20%;
        }

        .google-right-column {
            width: 40%;
        }

        .reviews-container {
            width: 100%; /* Set reviews container to 100% */
            padding: 20px; /* Optional padding for aesthetics */
            box-sizing: border-box; /* Include padding in width calculations */
        }

        .review-carousel {
            position: relative;
            overflow: hidden;
            width: 100%; /* Full width of parent */
        }

        .review-wrapper {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%; /* Full width of carousel */
        }

        .review {
            border: 1px solid #ddd;
            margin: 10px;
            padding: 15px;
            flex: 0 0 calc(33.333% - 20px); /* Three reviews in a row */
            box-sizing: border-box; /* Ensure padding and margin are included in size */
        }

        .review .rating {
            display: flex;
        }

        .review .date {
            color: #888;
            font-size: 0.9em;
        }

        .button-container {
            text-align: center;
            margin-top: 20px;
        }

        .review-nav-button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 10px; /* Add margin for spacing */
        }

        .review-nav-button.disabled {
            background-color: #d3d3d3;
            cursor: not-allowed;
        }

        #googleReviewsContainer {
            text-align: center;
            width: 100%; /* Ensure it takes full width */
        }

        .rating-score {
            width: 100%;
            display: flex;
        }
    </style>
</head>

<body>
<section id="companyReviewsContainer" class="companyReviewsContainer">

    <div class="google-left-column">
        <div class="h2">Honestidad y buen hacer</div>
        <div class="h3">Reseñas 100% reales</div>
        <div class="b1">
            Porque no es lo mismo que lo digamos nosotros a que lo digan nuestros clientes.
            Entra a ver nuestras reseñas de Google para ver opiniones real y honesta.
        </div>
        <div>
            <a href="https://maps.app.goo.gl/sQnD9PTjxBvz9rxY8" class="rounded-container rounded-both bg-orange h3"
               target="_blank" rel="noopener noreferrer nofollow">
                Ver opiniones reales
                <span class="fa-regular fa-arrow-right"></span>
            </a>
        </div>
    </div>

    <div id="googleReviewsContainer" class="google-right-column">
        <!-- Dynamic content will be inserted here -->
    </div>

    <div class="reviews-container">
        <div>Customer Reviews</div>
        <div class="review-carousel">
            <div class="review-wrapper" id="reviewWrapper">
                <!-- Reviews will be loaded here -->
            </div>
        </div>
        <div class="button-container">
            <button class="review-nav-button" id="reviewPrevBtn">◀ Prev</button>
            <button class="review-nav-button" id="reviewNextBtn">Next ▶</button>
        </div>
    </div>

</section>

<script>
// Global variable to track the current page of reviews
let currentPage = 0;

/**
 * Initializes the Google Reviews section with total reviews and average rating.
 * @param {number} totalReviews - The total number of reviews.
 * @param {number} averageRating - The average rating calculated from the reviews.
 */
function initializeGoogleReviews(totalReviews, averageRating) {
    const googleReviewsContainer = document.getElementById('googleReviewsContainer');
    googleReviewsContainer.innerHTML = `
        <div>
            <img src="google-logo.svg" alt="Reseñas Google">
            <p>Reseñas de Google</p>
        </div>
        <div>
            <p>${averageRating}</p>
            <div class="rating-score">${generateRatingStars(averageRating)}</div>
        </div>
        <div class="d-flex justify-content-center">
            <p>Puntuación basada en ${totalReviews} reseñas</p>
        </div>
    `;
}

/**
 * Counts total reviews.
 * @param {Array} reviews - An array of review objects.
 * @returns {number} - The total number of reviews.
 */
function countTotalReviews(reviews) {
    return reviews.length;
}

/**
 * Calculates the average rating from reviews.
 * @param {Array} reviews - An array of review objects.
 * @returns {number} - The average rating value rounded to 1 decimal place.
 */
function calculateAverageRating(reviews) {
    const totalStars = reviews.reduce((sum, review) => sum + review.rating, 0);
    return parseFloat((totalStars / reviews.length).toFixed(1)); // Round to 1 decimal place
}

/**
 * Fetches reviews from a JSON file and loads them into the carousel.
 */
async function fetchReviews() {
    try {
        const response = await fetch('data/reviews.json');
        const reviews = await response.json();
        
        // Calculate and display reviews data
        const totalReviews = countTotalReviews(reviews);
        const averageRating = calculateAverageRating(reviews);
        initializeGoogleReviews(totalReviews, averageRating);
        loadReviews(reviews);
        attachReviewEventListeners(totalReviews);
    } catch (error) {
        console.error('Error fetching reviews:', error);
    }
}

/**
 * Generates star ratings as SVG for the given rating.
 * @param {number} rating - The rating value (1 to 5).
 * @returns {string} - HTML string of SVG stars with correct filled amount.
 */
function generateRatingStars(rating) {
    const starSVG = (fillPercent) => `
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 23.44 19'>
            <polygon fill='#dadce0' points='10,15.27 16.18,19 14.54,11.97 20,7.24 12.81,6.63 10,0 7.19,6.63 0,7.24 5.46,11.97 3.82,19'/>
            <polygon fill='#fbbc04' points='10,15.27 16.18,19 14.54,11.97 20,7.24 12.81,6.63 10,0 7.19,6.63 0,7.24 5.46,11.97 3.82,19' style='clip-path: inset(0 ${100 - fillPercent}% 0 0);'/>
        </svg>
    `;
    return Array.from({ length: 5 }, (_, i) => starSVG(Math.max(0, Math.min(1, rating - i)) * 100)).join('');
}

/**
 * Loads reviews into the review carousel.
 * @param {Array} reviews - An array of review objects.
 */
function loadReviews(reviews) {
    const reviewWrapper = document.getElementById('reviewWrapper');
    reviewWrapper.innerHTML = reviews.map(review => `
        <div class="review">
            <h2>${review.name}</h2>
            <div class="rating">${generateRatingStars(review.rating)}</div>
            <p class="date">${review.date}</p>
            <p>${review.text}</p>
        </div>
    `).join('');
    updateCarousel(reviews.length);
}

/**
 * Updates the review carousel's position and button states.
 * @param {number} totalReviews - Total number of reviews.
 */
function updateCarousel(totalReviews) {
    const reviewWrapper = document.querySelector('.review-wrapper');
    const reviewWidth = document.querySelector('.review').offsetWidth + 20; // Including margin
    const offset = -currentPage * reviewWidth;

    reviewWrapper.style.transform = `translateX(${offset}px)`;
    updateButtonStates(totalReviews);
}

/**
 * Updates the visibility and state of the navigation buttons.
 * @param {number} totalReviews - Total number of reviews.
 */
function updateButtonStates(totalReviews) {
    const reviewPrevBtn = document.getElementById('reviewPrevBtn');
    const reviewNextBtn = document.getElementById('reviewNextBtn');
    const totalClicks = Math.ceil(totalReviews / 3) - 1; // Divide total reviews by 3 for total pages

    reviewPrevBtn.classList.toggle('disabled', currentPage === 0);
    reviewNextBtn.classList.toggle('disabled', currentPage >= totalClicks);
}

/**
 * Attaches event listeners to the navigation buttons.
 * @param {number} totalReviews - Total number of reviews.
 */
function attachReviewEventListeners(totalReviews) {
    const reviewNextBtn = document.getElementById('reviewNextBtn');
    const reviewPrevBtn = document.getElementById('reviewPrevBtn');

    reviewNextBtn?.addEventListener('click', () => {
        if (currentPage < Math.ceil(totalReviews / 3) - 1) { // Adjust for total pages
            currentPage++;
            updateCarousel(totalReviews);
        }
    });

    reviewPrevBtn?.addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            updateCarousel(totalReviews);
        }
    });
}

fetchReviews();
</script>
</body>
</html>