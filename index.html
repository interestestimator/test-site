<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Used Cars Listings</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="icons/mart-logo.png" alt="Logo">
            </div>
            <nav>
                <ul>
                    <li><a href="#">Home</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="listings-info">
        <div class="listing-count" id="listingCount">Loading...</div>
        <div class="sort-dropdown">
            <label id="sortLabel" class="sort-label">
                <object type="image/svg+xml" data="icons/sort-icon.svg" width="20" height="20">
                    Your browser does not support SVG
                </object> Sort: Relevance
            </label>
            <div class="sort-popup" id="sortPopup" style="display: none;">
                <div class="popup-title">
                    <div class="sort-text">Sort</div>
                    <button class="close-button" id="closeSortPopup">Close</button>
                </div>
                <div class="sort-options-container">
                    <div class="sort-option" data-value="relevance">Relevance</div>
                    <div class="sort-option" data-value="price-asc">Lowest Price</div>
                    <div class="sort-option" data-value="price-desc">Highest Price</div>
                    <div class="sort-option" data-value="mileage-asc">Lowest Mileage</div>
                    <div class="sort-option" data-value="mileage-desc">Highest Mileage</div>
                </div>
            </div>
        </div>
    </section>

    <section class="car-listings" id="carListings"></section>

    <script>
        async function fetchCarsData() {
            const response = await fetch('combined_data.json');
            const data = await response.json();
            return data.map(car => ({
                ...car,
                Price: parseFloat(car.Price),
            }));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const carsData = await fetchCarsData();

            const sortLabel = document.getElementById('sortLabel');
            const sortPopup = document.getElementById('sortPopup');
            const closeSortPopupButton = document.getElementById('closeSortPopup');

            sortLabel.addEventListener('click', () => {
                // Toggle visibility of sort popup
                sortPopup.style.display = sortPopup.style.display === 'none' ? 'block' : 'none';
            });

            closeSortPopupButton.addEventListener('click', () => {
                // Close the sort popup
                sortPopup.style.display = 'none';
            });

            sortPopup.addEventListener('click', (event) => {
                if (event.target.classList.contains('sort-option')) {
                    const selectedValue = event.target.getAttribute('data-value');
                    // Update displayed text on the label (without removing SVG)
                    const labelText = sortLabel.querySelector('object').outerHTML; // Preserve SVG
                    sortLabel.innerHTML = `${labelText} Sort: ${event.target.textContent}`;

                    // Hide the sort popup
                    sortPopup.style.display = 'none';
                    // Trigger re-rendering of car listings based on selected sort option
                    renderCarListings(carsData);
                }
            });

            renderCarListings(carsData);
        });

        function renderCarListings(carsData) {
            const container = document.getElementById('carListings');
            container.innerHTML = '';

            const sortOption = document.getElementById('sortLabel').textContent.split(': ')[1].trim();

            let filteredCars = [...carsData];

            if (sortOption === 'Lowest Price') {
                filteredCars.sort((a, b) => a.Price - b.Price);
            } else if (sortOption === 'Highest Price') {
                filteredCars.sort((a, b) => b.Price - a.Price);
            } else if (sortOption === 'Lowest Mileage') {
                filteredCars.sort((a, b) => a.Mileage - b.Mileage);
            } else if (sortOption === 'Highest Mileage') {
                filteredCars.sort((a, b) => b.Mileage - a.Mileage);
            }

            const formatter = new Intl.NumberFormat('eu', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });

            filteredCars.forEach(car => {
                const title = `${car.Manufacturer} ${car.Model} ${car.Year}`;
                const imageUrl = `images/${car.Reference}/cover.jpg`;

                const details = Object.entries(car)
                    .filter(([key]) => ['Mileage', 'Transmission', 'Engine', 'Power', 'Fuel', 'Color'].includes(key))
                    .map(([key, value]) => `
                        <div class="detail-box">
                            <img class="detail-icon" src="icons/${key.toLowerCase()}.png">
                            <span>${value}</span>
                        </div>
                    `).join('');

                const financePrice = calculateFinancePrice(car.Price);

                const carElement = `
                    <a href="car-details.html?id=${car.Reference}" class="car-container">
                        <img class="car-image" src="${imageUrl}" alt="${title}">
                        <div class="car-description-container">
                            <div class="car-title">${title}</div>
                            <div class="car-details-container">${details}</div>
                        </div>
                        <div class="price-container">
                            <div class="price">${formatter.format(car.Price)}</div>
                            <div class="finance-price">${formatter.format(financePrice)}/mo</div>
                        </div>
                    </a>
                `;
                container.insertAdjacentHTML('beforeend', carElement);
            });

            const listingCount = document.getElementById('listingCount');
            listingCount.textContent = `${filteredCars.length} listings`;
        }

        function calculateFinancePrice(price) {
            const deposit = 0;
            const interestRate = 14.9;
            const loanTermMonths = 60;

            const monthlyInterestRate = interestRate / 100 / 12;
            const financePrice = (price - deposit) * (monthlyInterestRate / (1 - Math.pow(1 + monthlyInterestRate, -loanTermMonths)));

            return financePrice;
        }
    </script>
</body>

</html>
