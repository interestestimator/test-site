<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car details</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #carDetailsContainer {
            display: flex;
            max-width: 1000px;
            margin: auto;
            flex-wrap: wrap;
        }

        #carInfoContainer {
            width: 66.666667%;
            overflow: hidden;
        }

        #carImage {
            border-radius: 1rem 1rem 0 0;
        }

        #carFinanceContainer {
            flex: 1;
            color: #333;
            position: sticky;
            background: #F7F8F8;
            margin-left: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 5.5rem;
            border-radius: 1rem;
        }

        #carTitle {
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1.2em;
            padding-top: 1.5rem;
            padding-bottom: .5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            text-transform: uppercase;
        }

        #carImageGallery {
            width: 66.666667%;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            #carImageGallery {
                width: 100%;
            }
        }

        #carImageContainer {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            touch-action: pan-y;
        }

        .navButtonContainer {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            width: calc(100% - 1rem);
            padding: 0.5rem;
        }

        .navButton {
            background-color: #FFFFFF;
            color: #141414;
            border: none;
            width: 2rem;
            height: 2rem;
            cursor: pointer;
            border-radius: 50%;
            opacity: 0.4;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            box-sizing: border-box;
        }

        #thumbnailContainer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.1rem;
            overflow: hidden;
            border-radius: 0 0 1rem 1rem;
        }

        .thumbnail {
            width: calc(25% - 0.25rem);
            height: auto;
            object-fit: cover;
            aspect-ratio: 16/9;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .thumbnail.active {
            opacity: 1;
        }

        p {
            margin-bottom: 10px;
        }

        #carFinanceContainer {
            position: sticky;
            top: 0;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background-color: #F7F8F8;
        }

        .tab.active {
            background-color: #FFFFFF;
            border-bottom: 1px solid #FFFFFF;
            border-top: 0.3rem solid #55A0D7;
            color: #D6B156;
        }

        .tab-content {
            padding: 20px;
            background-color: #FFFFFF;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        #financeContent {
            text-align: center;
        }

        #financeSliders input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #55A0D7 0%, #F7F8F8 0%);
            outline: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #financeSliders input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle, #55A0D7 30%, #FFFFFF 20%, #FFFFFF 50%, #55A0D7 50%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }

        #financeSliders input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: radial-gradient(circle, #55A0D7 30%, #FFFFFF 20%, #FFFFFF 50%, #55A0D7 50%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }

        #financeSliders input[type="range"]::-webkit-slider-runnable-track {
            -webkit-appearance: none;
            appearance: none;
        }

        #financeSliders input[type="range"]::-moz-range-track {
            background: transparent;
            border: none;
        }

        #financeSliders input[type="range"]::-moz-range-progress {
            background: #55A0D7;
            height: 8px;
            border-radius: 5px;
        }

        #overview {
            font-weight: bold;
            padding: 1rem;
        }

        .h3 {
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="icons/mart-logo.png" alt="Logo">
            </div>
            <nav>
                <ul>
                    <li><a href="#">Home</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="carDetailsContainer">
        <div id="carImageGallery">
            <div id="carTitle"></div> <!-- Car title goes here -->
            <div id="carImageContainer">
                <img id="carImage" class="car-image" alt="Car Image">
                <div class="navButtonContainer" id="navButtons">
                    <button class="navButton" id="prevImage">&lt;</button>
                    <button class="navButton" id="nextImage">&gt;</button>
                </div>
            </div>
            <div id="thumbnailContainer"></div>
        </div>

        <div id="carFinanceContainer">
            <div class="section" id="overview"></div>

            <div class="price-tabs-contain">
                <div class="tabs">
                    <div class="tab" id="tabFinan" onclick="showTab('finance')">
                        <div>
                            <small>Financiación desde</small>
                            <span class="h3" id="preFin">240€/mes</span>
                        </div>
                    </div>
                    <div class="tab active" id="tabInfo" onclick="showTab('normal')">
                        <div class="text-left">
                            <small>Precio al contado</small>
                            <span class="h3" id="preContado"></span>
                        </div>
                    </div>
                </div>
                <div class="tab-content">
                    <div id="financeContent" class="content" style="display:none;">
                        <div id="financeSliders">
                            <div>
                                <label for="depositSlider">Entrada Inicial</label>
                                <div id="selectedDeposit">12.000 €</div>
                                <input type="range" id="depositSlider" min="0" max="100000" step="1000" value="0">
                            </div>
                            <div>
                                <label for="yearsSlider">Select Years:</label>
                                <input type="range" id="yearsSlider" min="0" max="10" value="0">
                                <span id="selectedYears">0 Year</span>
                            </div>
                        </div>
                    </div>
                    <div id="normalContent" class="content" style="display:block;">
                        <p>Normal Payment Information Content here...</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="carInfoContainer">
            <div class="section" id="carroceria"></div>
            <div class="section" id="motorYTransmision"></div>
            <div class="section" id="consumoYEmisiones"></div>
            <div class="section" id="garantiaContainer"></div>
            <div class="section" id="equipamiento"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const state = {
                currentImageIndex: 0,
                thumbnailStartIndex: 0,
                thumbnailCount: 4,
                imageUrls: [],
                carReference: null,
                carData: null,
                startX: 0,
                startY: 0,
                startTime: 0
            };

            async function fetchCarDetails(reference) {
                try {
                    const response = await fetch(`listings/${reference}/data.json`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    state.carData = await response.json();
                    console.log('Car data:', state.carData);  // Log the car data here
                    return state.carData;
                } catch (error) {
                    console.error('Error fetching car details:', error);
                    return null;
                }
            }

            function getQueryParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }


            function preloadImages(imageUrls) {
                imageUrls.forEach(url => {
                    const img = new Image();
                    img.src = url;
                });
            }

            function updateThumbnailGallery() {
                const thumbnailContainer = document.getElementById('thumbnailContainer');
                thumbnailContainer.innerHTML = '';
                state.imageUrls.slice(state.thumbnailStartIndex, state.thumbnailStartIndex + state.thumbnailCount)
                    .forEach((url, index) => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'thumbnail' + (index === state.currentImageIndex ? ' active' : '');
                        img.addEventListener('click', () => showImage(index));
                        thumbnailContainer.appendChild(img);
                    });
            }

            function showImage(index) {
                if (index < 0 || index >= state.imageUrls.length) return;
                state.currentImageIndex = index;
                const carImage = document.getElementById('carImage');
                carImage.src = state.imageUrls[index];
                updateThumbnailGallery();
            }

            function showPrevImage() {
                if (state.currentImageIndex > 0) {
                    showImage(state.currentImageIndex - 1);
                } else {
                    showImage(state.imageUrls.length - 1);
                }
            }

            function showNextImage() {
                if (state.currentImageIndex < state.imageUrls.length - 1) {
                    showImage(state.currentImageIndex + 1);
                } else {
                    showImage(0);
                }
            }

            function handleTouchStart(e) {
                const touch = e.changedTouches[0];
                state.startX = touch.pageX;
                state.startY = touch.pageY;
                state.startTime = new Date().getTime();
                e.preventDefault();
            }

            function handleTouchEnd(e) {
                const touch = e.changedTouches[0];
                const distX = touch.pageX - state.startX;
                const distY = touch.pageY - state.startY;
                const elapsedTime = new Date().getTime() - state.startTime;
                const allowedTime = 300; // Maximum time allowed for swipe
                const threshold = 100; // Minimum distance for swipe
                const restraint = 100; // Maximum distance in the y direction

                if (elapsedTime <= allowedTime) {
                    if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
                        if (distX > 0) {
                            showPrevImage();
                        } else {
                            showNextImage();
                        }
                    }
                }
                e.preventDefault();
            }

            function showTab(tabName) {
                const tabs = document.querySelectorAll('.tab');
                const contents = document.querySelectorAll('.content');

                tabs.forEach(tab => tab.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));

                if (tabName === 'finance') {
                    document.getElementById('tabFinan').classList.add('active');
                    document.getElementById('financeContent').classList.add('active');
                } else {
                    document.getElementById('tabInfo').classList.add('active');
                    document.getElementById('normalContent').classList.add('active');
                }
            }

            function handleSliderInput(event) {
                const slider = event.target;
                if (slider.id === 'depositSlider') {
                    document.getElementById('selectedDeposit').textContent = `${slider.value} €`;
                } else if (slider.id === 'yearsSlider') {
                    document.getElementById('selectedYears').textContent = `${slider.value} Year${slider.value > 1 ? 's' : ''}`;
                }
            }

            async function renderCarDetails(car) {
                const carTitle = document.getElementById('carTitle');
                carTitle.textContent = car.JavaScriptInfo.nombre;
                const carImage = document.getElementById('carImage');
                carImage.src = state.imageUrls[0];

                const thumbnailContainer = document.getElementById('thumbnailContainer');
                thumbnailContainer.innerHTML = '';
                state.imageUrls.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'thumbnail' + (index === state.currentImageIndex ? ' active' : '');
                    img.addEventListener('click', () => showImage(index));
                    thumbnailContainer.appendChild(img);
                });

                const carImageContainer = document.getElementById('carImageContainer');
                carImageContainer.addEventListener('touchstart', handleTouchStart, false);
                carImageContainer.addEventListener('touchend', handleTouchEnd, false);

                const preContado = document.getElementById('preContado');
                preContado.textContent = `${car.JavaScriptInfo.precio} €`;

                document.getElementById('overview').textContent = car.JavaScriptInfo.descripcion || 'No description available.';
            }

            state.carReference = new URLSearchParams(window.location.search).get('id');

            if (!state.carReference) {
                document.getElementById('carDetailsContainer').innerHTML = '<p>No car reference provided.</p>';
                return;
            }

            const carDetails = await fetchCarDetails(state.carReference);

            if (carDetails) {
                const imagesCount = carDetails.JavaScriptInfo.cantidadImágenes || 5;
                state.imageUrls = Array.from({ length: imagesCount }, (_, i) => `listings/${state.carReference}/images/${i + 1}.jpg`);
                preloadImages(state.imageUrls);
                await renderCarDetails(carDetails);

                document.getElementById('prevImage').addEventListener('click', showPrevImage);
                document.getElementById('nextImage').addEventListener('click', showNextImage);
                document.getElementById('depositSlider').addEventListener('input', handleSliderInput);
                document.getElementById('yearsSlider').addEventListener('input', handleSliderInput);
            }

            document.getElementById('tabFinan').addEventListener('click', () => showTab('finance'));
            document.getElementById('tabInfo').addEventListener('click', () => showTab('normal'));
        });
    </script>
</body>

</html>
