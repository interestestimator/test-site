<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Details</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-checkbox.css">
    <link rel="stylesheet" href="style-popup-forms.css">
    <link rel="stylesheet" href="sliders.css">
    <link rel="icon" href="icons/company/favicon.ico" type="image/x-icon">


    <link rel="stylesheet" href="style-new.css">

    <style>
        .content-wrapper {
            display: grid;
            grid-template-columns: 60% 40%;
            /* Default layout for desktop */
            grid-template-rows: auto;
            align-items: start;
        }

        .left-column {
            display: flex;
            flex-direction: column;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            position: -webkit-sticky;
            /* For Safari */
            position: sticky;
            top: 1rem;
            /* Adjust top value if needed */
            height: fit-content;
            /* Ensure sticky behavior works */
        }

        /* Layout for mobile */
        @media (max-width: 767px) {
            .content-wrapper {
                grid-template-columns: 1fr;
                /* Single column layout for mobile */
                grid-template-rows: auto;
                /* Auto rows based on content */
            }

            .left-column,
            .right-column {
                width: 100%;
                /* Full width on mobile */
            }

            .right-column {
                position: static;
                /* Disable sticky behavior on mobile */
            }
        }










        .contact-strip {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            z-index: 1000; /* Ensure it's on top */
        }

        .contact-strip a {
            color: #ffcc00;
            text-decoration: none;
            margin: 0 1rem;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div id="header-container"></div>
    <!-- Banner -->
    <div id="banner-container"></div>

    <div id="overlay" class="overlay"></div>

    <!-- Popup Containers -->
    <section id="popupItems">
        <div id="consumptionPopup" class="popup-container" style="display: none;"></div>
        <div id="emissionsPopup" class="popup-container" style="display: none;"></div>
        <div id="documentsPopup" class="popup-container" style="display: none;"></div>
        <div id="contactPopup" class="popup-container" style="display: none;"></div>
        <div id="horsepowerPopup" class="popup-container" style="display: none;"></div>
        <div id="bodyTypePopup" class="popup-container" style="display: none;"></div>
    </section>

    <div class="car-listings content-wrapper">
        <div id="carTitle" class="h2"></div>
        <div id="sidebarDiscountDiv"></div>
        <div class="left-column">
            <div id="carImageContainer">
                <img id="carImage" class="car-image" alt="Car Image">
                <div class="navButtonContainer" id="navButtons">
                    <button class="navButton" id="prevImage">&lt;</button>
                    <button class="navButton" id="nextImage">&gt;</button>
                </div>
                <label id="photoCountLabel" class="photo-count-label"></label>
            </div>
            <div id="thumbnailContainer"></div>
        </div>

        <div class="right-column">
            <!-- Pricing and payment information -->
            <section id="carFinanceContainer" class=""></section>
        </div>

        <div class="left-column">
            <!-- Other information about car listing -->

            <section id="otherDetails">
                <div id="carOverviewContainer" class="details-container"></div>
                <div id="garantiaContainer" class="section"></div>
                <div id="equipamiento" class="section"></div>
            </section>

            <!-- Finance adjustment calculations -->
            <section id="vehicle-financing" class="bg-black">
                <div class="text-center mb-5">
                    <div class="container-title h2">Financiación 100% sin entrada</div>
                    <p>Grandes descuentos por financiar con nosotros. ¡Descúbrelos!</p>
                </div>

                <!-- Controls Section -->
                <div class="financing-calculator__controls">
                    <!-- Initial Deposit -->
                    <div class="financing-calculator__deposit">
                        <div class="dropdown-title rounded-container rounded-right bg-light-grey h3 italic">
                            <span class="label">Entrada inicial</span>
                            <input id="deposit-input" class="dropdown-title rounded-container rounded-right b1"
                                type="text" inputmode="decimal" value="&nbsp;">
                        </div>
                        <div class="silder-container">
                            <span class="ml-2 font-italic text-muted" id="max-deposit-text">Máxima: 5.400€</span>
                            <input id="deposit-slider" class="rangeSlider" type="range" min="0">
                        </div>
                    </div>

                    <!-- Initial Term -->
                    <div class="financing-calculator__term">
                        <div class="dropdown-title rounded-container rounded-right bg-light-grey h3 italic">
                            <span class="label">Duración</span>
                            <select class="rounded-container rounded-right bg-vl-grey b1" id="term-select">
                                <option value="2">2 años</option>
                                <option value="3">3 años</option>
                                <option value="4">4 años</option>
                                <option value="5">5 años</option>
                                <option value="6">6 años</option>
                                <option value="7">7 años</option>
                                <option value="8">8 años</option>
                                <option value="9">9 años</option>
                                <option value="10">10 años</option>
                            </select>
                        </div>
                        <div class="silder-container">
                            <input type="range" min="2" max="10" step="1" class="rangeSlider" id="term-slider">
                        </div>
                    </div>

                    <!-- Quota Button -->
                    <div class="financing-calculator__quota mt-4">
                        <span id="requestFinanceBtn" class="rounded-container rounded-right bg-orange h3 italic">
                            Quiero esta cuota
                            <span class="amount">315€/mes</span>
                        </span>
                    </div>
                </div>

                <!-- Summary Section -->
                <div id="loanPopup" class="financing-calculator__summary mt-4">
                    <!-- Popup content will be injected here by JavaScript -->
                </div>
            </section>

            <section id="companyAdvantagesContainer" class="details-container"></section>

            <div style="width: 100%; height: 400px;">
                <iframe 
                  src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d11664.826669712314!2d-7.5762373!3d43.037083!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd31ce5256c71689%3A0xc2eade902ecd0949!2sMart%C3%ADnez%20De%20Lugo%2C%20S.L.U.!5e0!3m2!1ses!2ses!4v1696847969220!5m2!1ses!2ses" 
                  width="100%" 
                  height="100%" 
                  style="border:0;" 
                  allowfullscreen="" 
                  loading="lazy" 
                  referrerpolicy="no-referrer-when-downgrade">
                </iframe>
              </div>
        </div>
    </div>

    <div class="contact-strip">
        <a href="tel:+1234567890" class="rounded-container rounded-both bg-orange h3">
            <svg width="24" height="24" viewBox="0 0 24 24" focusable="false" class="xwyK1d NMm5M">
                <path d="M16.02 14.46l-2.62 2.62a16.141 16.141 0 0 1-6.5-6.5l2.62-2.62a.98.98 0 0 0 .27-.9L9.15 3.8c-.1-.46-.51-.8-.98-.8H4.02c-.56 0-1.03.47-1 1.03a17.92 17.92 0 0 0 2.43 8.01 18.08 18.08 0 0 0 6.5 6.5 17.92 17.92 0 0 0 8.01 2.43c.56.03 1.03-.44 1.03-1v-4.15c0-.48-.34-.89-.8-.98l-3.26-.65c-.33-.07-.67.04-.91.27z"></path>
            </svg>
            <span class="text-left">Call</span>
        </a>
        
        

        <a href="https://wa.me/34677585804?text=Hola%20me%20gustaría%20saber%20más" target="_blank" class="rounded-container rounded-both bg-orange h3">
            <span class="text-left">WhatsApp</span>
          </a>

        <a id="contactUsBtn" href="#" class="rounded-container rounded-both bg-orange h3">
            <img src="icons/ui/actions/contact-us.svg" alt="Icon" width="28" height="28"
                class="btn-icon">
            <span class="text-left">Email</span>
        </a>
    </div>

    <div id="footer-container"></div>
</body>


<script type="module">
    import { loadHtml } from './js/httpUtils.js';  // Update the import path and function names
    import { loadCarDetails } from './js/carDataFetcher.js';  // Update the import path and function names
    import { formatCurrency } from './js/formatCarData.js';  // Importing the initializer function
    import { createInitialSiteState, getGlobalDOMElements, getCarDetailsDOMElements } from './js/siteSetup.js';
    import { setLoanParameters, calculateRate } from './js/financeCalc.js';
    import { setupStateImages, preloadImages, setupImageEventListeners } from './js/imageNavigation.js';

    import { handleDeliveryCheckboxChange, handleFinanceCheckboxChange } from './checkboxHandlers.js';
    import { initializeFinanceCalcEventListeners, generateFinanceMessage } from './updateFinanceCalc.js';
    import { showConsumptionInfo, showEmissionsInfo, showHorsepowerInfo, showBodyTypeInfo } from './popupInformation.js';
    import { showContactForm, FORM_TYPES } from './popupForms.js';


    // Function to initialize header-related functionality
    function initializeHeader() {
        document.querySelector('.menu-toggle').addEventListener('click', () => {
            const navList = document.getElementById('navList');
            navList.classList.toggle('active');
        });
    }



    function initializeBanner() {
        let currentMessageIndex = 0;
        const container = document.querySelector('.message-container');
        const messages = document.querySelectorAll('.message1');
        const totalMessages = messages.length;

        function showNext() {
            currentMessageIndex = (currentMessageIndex + 1) % totalMessages;
            const newTranslateX = -(currentMessageIndex * 100);
            container.style.transform = `translateX(${newTranslateX}%)`;

            messages.forEach((message, index) => {
                message.setAttribute('aria-hidden', index !== currentMessageIndex);
            });
        }

        setInterval(showNext, 5000);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const state = createInitialSiteState();
        const elements = { ...getGlobalDOMElements(), ...getCarDetailsDOMElements() };

        if (!state.carId) {
            if (elements.carDetailsContainer) {
                elements.carDetailsContainer.innerHTML = '<p>No car reference provided.</p>';
            }
            return;
        }

        // Load header and footer HTML content
        await Promise.all([
            loadHtml(elements.headerContainer, 'header.html'),
            loadHtml(elements.bannerContainer, 'banner.html'),
            loadHtml(elements.footerContainer, 'footer.html')
        ]);

        initializeHeader(); // Initialize header functionality after HTML is loaded
        initializeBanner(); // Initialize banner functionality after HTML is loaded




        // Load car details and update state
        state.currentCarData = await loadCarDetails(`listings/${state.carId}`);
        const { currentCarData } = state;

        if (currentCarData) {
            setupStateImages(state, currentCarData.imageCount);
            preloadImages(state.imageUrlList, state, elements.thumbnailContainer);
            setupImageEventListeners(state, elements);

            // Populate and initialize UI components 
            populateCarSections(elements, currentCarData);
            setupEventListeners(state, elements);
            initializeCheckboxes(currentCarData);
            initializeDetails(currentCarData);

            renderCarDetails(state, elements, currentCarData);

        }

        const sliders = document.querySelectorAll('.rangeSlider');
        sliders.forEach(slider => {
            updateSlider(slider); // Initialize slider background
            slider.addEventListener('input', () => updateSlider(slider)); // Update background on input
        });
    });

    /**
     * Sets up event listeners for various UI components.
     * @param {Object} state - The state object.
     * @param {Object} elements - The DOM elements.
     */
    function setupEventListeners(state, elements) {
        const { currentCarData } = state;
        const { carId, brand, model, version, rawPrice, rawFinancePrice } = currentCarData;
        const carReference = `${brand} ${model} ${version}`;

        // Set up event listeners and MutationObserver
        setupButtonEventListener(carId, carReference, currentCarData);
        setupCheckboxMutationObserver(state, rawPrice, rawFinancePrice);
    }

    /**
     * Sets up event listeners for various buttons.
     * @param {string} carId - The car ID.
     * @param {string} carReference - The car reference string.
     * @param {Object} currentCarData - The current car data object.
     */
    function setupButtonEventListener(carId, carReference, currentCarData) {
        // Event listeners for different form types
        document.getElementById('priceAlertBtn').addEventListener('click', (event) => showContactForm(event, FORM_TYPES.PRICE_ALERT, currentCarData.carId, carReference, currentCarData.financePrice, currentCarData.price));
        document.getElementById('testDriveBtn').addEventListener('click', (event) => showContactForm(event, FORM_TYPES.TEST_DRIVE, currentCarData.carId, carReference));
        document.getElementById('contactUsBtn').addEventListener('click', (event) => showContactForm(event, FORM_TYPES.CONTACT_US)), currentCarData.carId;
        // TEMPORARY     document.getElementById('requestEmailBtn').addEventListener('click', (event) => showContactForm(event, FORM_TYPES.REQUEST_EMAIL, currentCarData.carId, 'Model X - 2024')); // FINALISE OR REMOVE THIS OPTION
        document.getElementById('requestFinanceBtn').addEventListener('click', (event) => showContactForm(event, FORM_TYPES.REQUEST_FINANCE, currentCarData.carId, carReference, '', '', generateFinanceMessage(carReference, currentCarData.financePrice)));

    }

    /**
     * Sets up MutationObserver to handle dynamically added checkboxes.
     * @param {Object} state - The state object.
     * @param {number} rawPrice - The raw price of the car.
     * @param {number} rawFinancePrice - The raw finance price of the car.
     */
    function setupCheckboxMutationObserver(state, rawPrice, rawFinancePrice) {
        const financeOptionsContainer = document.getElementById('carFinanceOptionsContainer');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(({ addedNodes }) => {
                if (addedNodes.length) {
                    const financeCheckbox = document.getElementById('financeCheckbox');
                    const deliveryCheckbox = document.getElementById('deliveryCheckbox');

                    if (financeCheckbox) {
                        financeCheckbox.addEventListener('change', (event) => {
                            handleFinanceCheckboxChange(event, state, rawPrice, rawFinancePrice);
                        });
                    }

                    if (deliveryCheckbox) {
                        deliveryCheckbox.addEventListener('change', async (event) => {
                            await handleDeliveryCheckboxChange(event, state);
                        });
                    }
                }
            });
        });

        observer.observe(financeOptionsContainer, { childList: true });
    }

    /**
     * Renders car details into the designated elements.
     * @param {Object} state - The state object.
     * @param {Object} elements - The DOM elements.
     * @param {Object} currentCarData - The car data object.
     */
    function renderCarDetails(state, elements, currentCarData) {
        const { year, rawFinancePrice, rawKilometres } = currentCarData;

        // Update car details
        elements.carImageElement.src = state.imageUrlList[0];
        elements.photoCountLabel.innerHTML = `<img src="icons/ui/actions/photo-count.svg" alt="Info Icon" width="16" height="16">${state.currentImageIdx + 1} of ${currentCarData.imageCount}`;

        // Setup dropdowns
        setupDropdowns();

        // Calculate and display financing details
        const vehicleDeposit = rawFinancePrice * 0.25;
        const { annualRateTIN, loanLengthMonths, commissionRate } = setLoanParameters(year, rawKilometres, rawFinancePrice);

        const result = calculateRate(
            loanLengthMonths / 12,
            rawFinancePrice,
            vehicleDeposit,
            annualRateTIN / 100,
            commissionRate / 100,
            0.0
        );

        insertFinanceSidebar(formatCurrency(Math.abs(result.pmt)))

        // Initialize setup
        initializeFinanceCalcEventListeners(rawFinancePrice, annualRateTIN, commissionRate, vehicleDeposit, loanLengthMonths, elements);  /////////// PASS TERM FROM FINANCE CALCULATION PARAMETERS /////
    }



    function initializeCheckboxes(currentCarData) {
        const financeOptionsContainer = document.getElementById('carFinanceOptionsContainer');

        // Create and append the first checkbox div for finance options
        const financeDiv = document.createElement('div');
        financeDiv.className = 'price-group__entry checkbox-wrapper';
        financeDiv.innerHTML = `
            <input type="checkbox" id="financeCheckbox" checked>
            <label for="financeCheckbox"></label>
            <span id="financeAmount_title" class="b1">Descuento por financiación</span>
            <span class="entry__amount h3" id="financeAmount">-${formatCurrency(currentCarData.rawPrice - currentCarData.rawFinancePrice)}*</span> 
        `;
        financeOptionsContainer.appendChild(financeDiv);

        // Create and append the second checkbox div for warranty options
        const warrantyDiv = document.createElement('div');
        warrantyDiv.className = 'price-group__entry checkbox-wrapper';
        warrantyDiv.innerHTML = `
            <span id="warrantyAmount_title" class="b1">Garantía nacional de 12 meses</span>
            <span class="entry__amount h3" id="warrantyAmount">0 €</span>
        `;
        financeOptionsContainer.appendChild(warrantyDiv);

        // Create and append the third checkbox div for vehicle exchange
        const exchangeDiv = document.createElement('div');
        exchangeDiv.className = 'price-group__entry checkbox-wrapper';
        exchangeDiv.innerHTML = `
            <span id="exchangeAmount_title" class="b1">Entrega vehículo a cambio</span>
            <a href="/vender-mi-coche.html?id=${currentCarData.carId}" class="rounded-container rounded-left bg-black h3 italic">Valorar coche</a>
        `;
        financeOptionsContainer.appendChild(exchangeDiv);

        // Create and append the fourth checkbox div for delivery options
        const deliveryDiv = document.createElement('div');
        deliveryDiv.className = 'price-group__entry checkbox-wrapper';
        deliveryDiv.innerHTML = `
            <input type="checkbox" id="deliveryCheckbox">
            <label for="deliveryCheckbox"></label>
            <span id="deliveryLabel_title" class="b1">Entrega a domicilio</span>
            <select id="regionDropdown" style="display: none;"></select>
            <span class="entry__amount h3" id="regionAmount">Activar</span>
        `;
        financeOptionsContainer.appendChild(deliveryDiv);
    }

    /**
     * Creates a detail div with icon, value, and title.
     * @param {string} containerId - The ID of the container to append the detail div.
     * @param {string} iconFolder - The folder containing the icon.
     * @param {string} iconName - The icon name to display.
     * @param {string} value - The detail value to display.
     * @param {string} title - The detail title to display.
     * @param {string} [additionalInfo=''] - Optional additional info to display.
     */
    function createDetailDiv(containerId, iconFolder, iconName, value, title, additionalInfo = '') {
        const container = document.getElementById(containerId);
        const detailDiv = document.createElement('div');
        detailDiv.className = 'more-details';

        detailDiv.innerHTML = `
        <img src="icons/${iconFolder}/${iconName}.svg" alt="${title}" width="48" height="48">
        <div class="detail-text b1">
            <span class="font-bold uppercase">${value}</span>
            <span class="txt-grey">${title}</span>
            ${additionalInfo ? `<label class="more-information ${iconName}">
                <img src="icons/ui/actions/more-info.svg" alt="More information" width="12" height="12">
                ${additionalInfo}
            </label>` : ''}
        </div>
    `;

        container.appendChild(detailDiv);
    }

    /**
     * Initializes detail and advantage sections with data.
     * @param {Object} currentCarData - Object containing car data.
     */
    function initializeDetails(currentCarData) {
        const defaultDetailsIconFolder = 'car-details'; // Standard folder for details icons
        const defaultAdvantagesIconFolder = 'company/advantages'; // Standard folder for advantages icons

        const details = [
            { id: 'kilometres', value: `${currentCarData.rawKilometres} km`, title: 'Kilometres' },
            { id: 'horsepower', value: `${currentCarData.powerCV} CV`, title: 'Horsepower', additionalInfo: 'Engine Specs' },
            { id: 'fuel', value: currentCarData.fuelType, title: 'Fuel Type' },
            { id: 'transmission', value: currentCarData.transmissionType, title: 'Transmission' },
            { id: 'gears', value: currentCarData.gears, title: 'Nº Gears' },
            { id: 'registration', value: currentCarData.year, title: 'Car Registered' },
            { id: 'bodyType', value: `${currentCarData.bodyType}`, title: 'Body Type', additionalInfo: 'Body Details' },
            { id: 'doors', value: currentCarData.doors, title: 'Nº doors' },
            { id: 'seats', value: currentCarData.seats, title: 'Nº Seats' },
            { id: 'colour', value: currentCarData.color, title: 'Colour Exterior' },
            { id: 'consumption', value: `${currentCarData.averageConsumption} l/100 km`, title: 'Fuel Consumption', additionalInfo: 'Consumption Details' }
        ];

        if (currentCarData.emissionLabel !== '') {
            details.push({
                id: currentCarData.emissionLabel,
                value: `${currentCarData.co2Emissions} g/km`,
                title: 'Emissions CO2',
                iconFolder: 'car/emission-types', // Specific folder for emissions
                additionalInfo: 'More Information'
            });
        }

        details.forEach(({ id, value, title, iconFolder = defaultDetailsIconFolder, additionalInfo }) => {
            createDetailDiv('carOverviewContainer', iconFolder, id, value, title, additionalInfo);
        });

        const advantages = [
            { id: 'documentation', value: 'Vehículos revisados', title: 'Revisión de 250 puntos revisados por nuestro equipo de profesionales.' },
            { id: 'mileage-guarantee', value: 'Kilometraje garantizado', title: 'Somos transparentes. Compra tu coche con certificado de kilómetros reales.' },
            { id: 'guarantee', value: 'Garantía de 12 meses', title: 'Este vehículo dispone de una garantía de 12 meses.' },
            { id: 'home-delivery', value: 'Envío a domicilio', title: 'Sin desplazamientos, te lo llevamos a casa. Antes de lo que crees, lo tendrás en tus manos.' },
            { id: 'part-exchange', value: 'Aceptamos tu coche como parte del pago', title: 'Te ofrecemos las tasaciones más competitivas del mercado.' },
            { id: 'test-drive', value: 'Pruébalo sin compromiso', title: 'Dispones de 15 días o 1.000 km para probar el vehículo. Si no te convence, cámbialo por otro.' }
        ];

        advantages.forEach(({ id, value, title }) => {
            createDetailDiv('companyAdvantagesContainer', defaultAdvantagesIconFolder, id, value, title);
        });

        // Adding event listeners for dynamically created elements
        document.querySelectorAll('.more-information').forEach(el => {
            const className = el.classList[1];
            if (className === 'consumption') {
                el.addEventListener('click', (event) => showConsumptionInfo(event, currentCarData));
            } else if (className === currentCarData.emissionLabel) {
                el.addEventListener('click', (event) => showEmissionsInfo(event, currentCarData));
            } else if (className === 'horsepower') {
                el.addEventListener('click', (event) => showHorsepowerInfo(event, currentCarData));
            } else if (className === 'displacement') {
                el.addEventListener('click', (event) => showDisplacementInfo(event, currentCarData));
            } else if (className === 'bodyType') {
                el.addEventListener('click', (event) => showBodyTypeInfo(event, currentCarData));
            }
        });
    }









    /**
     * Populates various sections with data from the car object.
     * @param {Object} elements - The DOM elements to populate.
     * @param {Object} currentCarData - The car data object.
     */
    function populateCarSections(elements, currentCarData) {
        initializeFinanceSection(elements.financeSectionContainer)



        insertCarTitle(elements.carTitleContainer, currentCarData);
        // TEMPORARY     insertCarOverview(elements.carOverviewContainer, currentCarData);
        insertDiscountSection(currentCarData.rawPreviousPrice, currentCarData.rawPrice);
        insertCarPriceItems(currentCarData.financePrice, currentCarData.price);
        insertCarPriceResults(currentCarData.financePrice);
        // TEMPORARY     insertInclusionsAndBenefits(elements.benefitsContainer, currentCarData.standardWarranty);
        // TEMPORARY     insertCarReferenceID(elements.carReferenceContainer, currentCarData.carId);
        insertWarrantyData(elements.warrantyContainer, currentCarData.standardWarranty);
        // TEMPORARY     insertPrintDetailsButton(elements.printDetailsContainer, currentCarData.carId);

        insertCarFeaturesOverview(elements.equipmentDropdownsContainer, currentCarData);
    }

    /**
     * Inserts a formatted car title into the specified container element.
     *
     * @param {HTMLElement} carTitleContainer - The container element where the car title will be inserted.
     * @param {Object} currentCarData - An object containing the car data to display.
     */
    function insertCarTitle(carTitleContainer, currentCarData) {
        if (!carTitleContainer) return; // Early return if the element is not found

        carTitleContainer.innerHTML = `
            ${currentCarData.brand} ${currentCarData.model} ${currentCarData.version || ''} 
            ${currentCarData.displacementLiters} ${currentCarData.EngineTechnology} 
            ${currentCarData.color} ${currentCarData.bodyType} (${currentCarData.doors}p)
        `;
    }

    /**
     * Inserts a formatted car overview into the specified container element.
     *
     * @param {HTMLElement} carOverviewContainer - The container element where the car overview will be inserted.
     * @param {Object} currentCarData - An object containing the car data to display.

    function insertCarOverview(carOverviewContainer, currentCarData) {
        if (!carOverviewContainer) return; // Early return if the element is not found

        carOverviewContainer.innerHTML = `
            ${currentCarData.year} | ${currentCarData.transmissionType} | ${currentCarData.kilometres} km | 
            ${currentCarData.fuelType} | ${currentCarData.powerKW} kW (${currentCarData.powerCV} CV)` || 'Descripción no disponible';
    }
    */

    /**
     * Inserts a discount section into a specified container element.
     * @param {HTMLElement} discountContainer - The container element to insert the discount section into.
     * @param {number} rawPreviousPrice - The original price before the discount.
     * @param {number} rawPrice - The price after the discount.
     */
    function insertDiscountSection(rawPreviousPrice, rawPrice) {
        const discountContainer = document.getElementById('sidebarDiscountDiv');
        if (!discountContainer) return; // Early return if the element is not found

        const savingsAmount = rawPreviousPrice - rawPrice;

        if (savingsAmount <= 0) {
            discountContainer.style.visibility = 'hidden';
        } else {
            const discountPercentage = ((savingsAmount / rawPreviousPrice) * 100).toFixed(0);
            discountContainer.innerHTML = `
                <div class="sidebar__discount">
                    <span class="h3">¡Te ahorras ${formatCurrency(savingsAmount)}!</span>
                    <label id="discountLabel" class="rounded-container rounded-both bg-orange h3">
                        <img src="icons/ui/promotions/discount.svg" width="18" height="18" alt="Discount Icon">
                        <span>${discountPercentage}% descuento</span>
                    </label>
                </div>
            `;
            discountContainer.style.visibility = 'show';
        }
    }

    /**
     * Inserts car pricing information into a specified container element.
     * @param {HTMLElement} priceItemsContainer - The container element to insert the pricing information into.
     * @param {string} financePrice - The price if financed.
     * @param {string} price - The price if paid in full.
     */
    function insertCarPriceItems(financePrice, price) {
        const priceItemsContainer = document.getElementById('priceItems');
        if (!priceItemsContainer) return; // Early return if the element is not found

        priceItemsContainer.innerHTML = `
            <div class="box txt-left contrast">
                <span class="h3 italic">Financiando</span>
                <span class="b1">sujeto a financiación</span>
                <span id="precioFinacio" class="h2">${financePrice}*</span>
            </div>
            <div class="box txt-right">
                <span class="h3 italic">Al contado</span>
                <span class="b1">sin financiación</span>
                <span id="precioNuevo" class="h2">${price}*</span>
            </div>
        `;
    }

    /**
     * Inserts the final car price into a specified container element.
     * @param {HTMLElement} priceResultsContainer - The container element to insert the final price into.
     * @param {string} financePrice - The final car finance price.
     */
    function insertCarPriceResults(financePrice) {
        const priceResultsContainer = document.getElementById('vehicle-price-result');
        if (!priceResultsContainer) return; // Early return if the element is not found

        priceResultsContainer.innerHTML = `

            <span id="pmtValue" class="b1">
                <span class="h3">Precio Final</span><br>
                <span>Todo incluido. Llave en mano.</span>
            </span>
            <span id="PrecioFinal" class="h2">${financePrice}*</span>
        `;
    }

    /**
     * Inserts an inclusions and benefits message into a specified container element.
     * @param {HTMLElement} benefitsContainer - The container element to insert the inclusions and benefits message into.
     * @param {number} guaranteePeriod - The length of the guarantee period in months.

    function insertInclusionsAndBenefits(benefitsContainer, guaranteePeriod) {
        if (!benefitsContainer) return; // Early return if the element is not found

        benefitsContainer.innerHTML = `
            <div class="benefits-message__title">
                Incluido <u>GRATIS</u>
            </div>
            <ul class="list-vertical list-vertical--check pl-1 mb-0">
                <li>${guaranteePeriod} meses de garantía</li>
                <li>Costes de gestión y transferencia</li>
            </ul>
        `;
    }
     */

    /**
     * Inserts a car reference ID into a specified container element.
     * @param {HTMLElement} carReferenceContainer - The container element to insert the car reference ID into.
     * @param {string} carID - The car reference ID.

    function insertCarReferenceID(carReferenceContainer, carID) {
        if (!carReferenceContainer) return; // Early return if the element is not found

        carReferenceContainer.innerHTML = `
            <p class="background-color--neutral-100 px-3 py-2 border-radius-3 d-inline-block">
                <span class="fal fa-hashtag"></span> Referencia:
                MARTINEZDELUGO-${carID}
            </p>
        `;
    }
    */

    /**
     * Inserts a warranty section into a specified container element.
     * @param {HTMLElement} warrantyContainer - The container element to insert the warranty section into.
     * @param {number} guaranteePeriod - The length of the warranty in months.
     */
    function insertWarrantyData(warrantyContainer, guaranteePeriod) {
        if (!warrantyContainer) return; // Early return if the element is not found

        // Define VIP and standard guarantee periods
        const vipGuaranteeMonths = 24; // VIP guarantee in months
        const standardGuaranteeMonths = 12; // Standard guarantee in months

        // Generate the warranty message based on the guarantee period
        const warrantyMessage = guaranteePeriod === vipGuaranteeMonths
            ? `En Martínez de Lugo, tu satisfacción es nuestra prioridad. Tu coche ya incluye una garantía VIP de 
            ${vipGuaranteeMonths} meses, asegurando una protección completa y tranquilidad durante todo este tiempo.`
            : `En Martínez de Lugo, tu satisfacción es nuestra prioridad. Ofrecemos una garantía estándar de ${standardGuaranteeMonths} meses, 
            para que disfrutes de tu coche con total confianza. Además, tienes la opción de mejorar a nuestra garantía 
            VIP, extendiendo la cobertura a ${vipGuaranteeMonths} meses por un coste adicional.`;

        // Insert the HTML structure into the container
        warrantyContainer.innerHTML = `
            <h3>Garantía</h3>
            <p>${warrantyMessage}</p>
            <p class="mt-3 mb-0 color--neutral-300">
                <small>* La garantía está sujeta a disponibilidad y a los términos y condiciones aplicables.</small>
            </p>
        `;
    }

    /**
     * Inserts a print details button into a specified container element.
     * @param {HTMLElement} printDetailsContainer - The container element to insert the print details button into.
     * @param {string} carID - The car reference ID to be included in the button URL.

    function insertPrintDetailsButton(printDetailsContainer, carID) {
        if (!printDetailsContainer) return; // Early return if the element is not found

        printDetailsContainer.innerHTML = `
            <span class="col-6 text-center">
                <a href="/print-car-data.html?id=${carID}" rel="nofollow"> Imprimir ficha</a>
            </span>
        `;
    }
    */







    /**
     * Inserts a finance details button into a specified container element.
     * @param {string} financePrice - The car finance price to be included in the container.
     */
    function insertFinanceSidebar(financePrice) {
        const financeSidebarContainer = document.getElementById('initalFinanceValue');

        if (!financeSidebarContainer) return; // Early return if the element is not found

        financeSidebarContainer.innerHTML = `
                <span id="pmtValue" class="b1">
                    <span class="font-bold">Llévatelo financiado</span><br>
                    Desde <span class="h3">${financePrice}*</span>/mes
                </span>
                <a href="#vehicle-financing" class="rounded-container rounded-left bg-black h3 italic">Recalcular cuota</a>
        `;
    }




    // Constants
    const ICON_OPEN_SRC = 'icons/ui/navigation/dropdown-open.svg';
    const ICON_CLOSED_SRC = 'icons/ui/navigation/dropdown-closed.svg';

    /**
     * Toggles the visibility of a specific dropdown and updates its icon and background color.
     * @param {HTMLElement} dropdownTitle - The title element of the dropdown being toggled.
     */
    function toggleDropdown(dropdownTitle) {
        const targetId = dropdownTitle.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);
        const imgElement = dropdownTitle.querySelector('img');

        const isOpen = targetElement.classList.toggle('show');
        imgElement.src = isOpen ? ICON_OPEN_SRC : ICON_CLOSED_SRC;

        // Toggle background color between black when open and grey when closed
        dropdownTitle.classList.toggle('bg-black', isOpen);
        dropdownTitle.classList.toggle('bg-light-grey', !isOpen);

        return { targetElement, isOpen };
    }

    /**
     * Closes all dropdowns except the currently active one.
     * @param {HTMLElement} activeDropdown - The currently active dropdown element.
     */
    function closeOtherDropdowns(activeDropdown) {
        document.querySelectorAll('.equipamiento-dropdown-content.show').forEach(content => {
            if (content !== activeDropdown) {
                content.classList.remove('show');
                content.previousElementSibling.classList.remove('bg-black');
                content.previousElementSibling.classList.add('bg-light-grey');
                content.previousElementSibling.querySelector('img').src = ICON_CLOSED_SRC;
            }
        });
    }

    /**
     * Handles the click event to toggle the dropdown and manage the visibility of others.
     * @param {Event} event - The click event on the dropdown title.
     */
    function handleDropdownClick(event) {
        const dropdownTitle = event.currentTarget;
        const { targetElement, isOpen } = toggleDropdown(dropdownTitle);

        if (isOpen) {
            closeOtherDropdowns(targetElement);
        }
    }

    /**
     * Initializes the dropdown functionality by setting up event listeners and showing the default dropdown.
     * @param {string} defaultDropdownId - The ID of the dropdown to show by default.
     */
    function setupDropdowns(defaultDropdownId = 'exteriorContent') {
        // Attach event listeners to all dropdown titles
        document.querySelectorAll('.dropdown-title').forEach(title =>
            title.addEventListener('click', handleDropdownClick)
        );

        // Show the default dropdown
        const defaultDropdown = document.getElementById(defaultDropdownId);
        if (defaultDropdown) {
            toggleDropdown(defaultDropdown.previousElementSibling);
        }
    }

    /**
     * Inserts a formatted car features overview into the specified container element.
     * @param {HTMLElement} equipmentDropdownsContainer - The container element where the dropdowns will be inserted.
     * @param {Object} currentCarData - An object containing the car equipment data to display.
     */
    function insertCarFeaturesOverview(equipmentDropdownsContainer, currentCarData) {
        if (!equipmentDropdownsContainer) return; // Early return if the element is not found

        // Define feature sections and their respective keys
        const featureSections = [
            { title: 'Exterior', key: 'exteriorEquipment', targetId: 'exteriorContent' },
            { title: 'Interior', key: 'interiorEquipment', targetId: 'interiorContent' },
            { title: 'Multimedia', key: 'multimediaFeatures', targetId: 'multimediaContent' },
            { title: 'Seguridad', key: 'safetyFeatures', targetId: 'seguridadContent' },
        ];

        // Generate HTML for each feature section
        const carFeaturesHTML = featureSections.map(({ title, targetId, key }) => {
            const features = currentCarData[key] || [];
            const listItems = features.map(item => `<li>${item}</li>`).join('');
            return `
        <div class="dropdown">
            <label class="dropdown-title rounded-container rounded-right bg-light-grey h3 italic" data-target="${targetId}">
                ${title}
                <img src="${ICON_CLOSED_SRC}" alt="Dropdown Icon" class="dropdown-icon">
            </label>
            <div id="${targetId}" class="equipamiento-dropdown-content">
                <ul class="custom-list">${listItems}</ul>
            </div>
        </div>
    `;


        }).join('');

        // Insert the generated HTML into the container
        equipmentDropdownsContainer.innerHTML = `
    <div class="dropdown-container">
        <div class="container-title h2">Car Features</div>
        ${carFeaturesHTML}
    </div>
    `;
    }




    /**
     * Initialize a finance section into a specified container element.
     * @param {HTMLElement} financeSectionContainer - The container element to initialize the finance section before inserting other elements.
     */
    function initializeFinanceSection(financeSectionContainer) {
        if (!financeSectionContainer) return; // Early return if the element is not found

        financeSectionContainer.innerHTML = `
                
                    <div id="priceItems" class="price-items"></div>
                    <div id="initalFinanceValue" class="sidebar__financing"></div>
                    <div id="carFinanceOptionsContainer" class="price-group"></div>
                    <div class="vehicle-price-result-container bg-black">
                        <div id="vehicle-price-result" class="vehicle-price-result"></div>

                        <div class="vehicle-price-result__action">
                            <button id="priceAlertBtn" class="rounded-container rounded-both bg-orange h3">
                                <img src="icons/ui/actions/notify-me.svg" alt="Icon" width="22" height="22"
                                    class="btn-icon">
                                <span>Avísame si baja de precio</span>
                            </button>
                        </div>

                        <div class="vehicle-price-result__action">
                            <button id="testDriveBtn" class="rounded-container rounded-both bg-orange h3">
                                <img src="icons/ui/actions/test-drive.svg" alt="Icon" width="22" height="22"
                                    class="btn-icon">
                                <span>Pruébalo sin compromiso</span>
                            </button>
                        </div>
                    </div>
        `;
    }






















    function updateSlider(slider) {
        const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
        slider.style.background = `linear-gradient(to right, #FE5100 ${value}%, #B5B5B5 ${value}%)`;
    }









    ///financeOptionsContainer: 'carFinanceOptionsContainer', (initializeCheckboxes)
    ///financeSidebarContainer: 'initalFinanceValue',
    ///priceItemsContainer: 'priceItems',
    ///priceResultsContainer: 'vehicle-price-result',
    ///discountContainer: 'sidebarDiscountDiv',



</script>


