<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Details</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-checkbox.css">
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
</head>

<body>
    <div id="header-container"></div>
    <div class="car-listings">
        <div id="carDetailsContainer">
            <div id="carImageGallery">
                <div id="carTitle"></div>
                <div id="carImageContainer">
                    <img id="carImage" class="car-image" alt="Car Image">
                    <div class="navButtonContainer" id="navButtons">
                        <button class="navButton" id="prevImage">&lt;</button>
                        <button class="navButton" id="nextImage">&gt;</button>
                    </div>
                    <label id="photoCountLabel" class="photo-count-label">
                        <img src="icons/photo-count.svg" alt="Info Icon" width="16" height="16">
                    </label>
                </div>
                <div id="thumbnailContainer"></div>
            </div>

            <div id="carFinanceContainer">
                <div class="section" id="overview"></div>

                <!-- Pay Details Section Start -->
                <section class="pay-details-section">
                    <div class="sidebar">
                        <div class="sidebar__prices">
                            <div class="sidebar__discount">
                                <label id="discountLabel" class="discount-label">
                                    <img src="icons/discount-icon.svg" width="18" height="18" alt="Discount Icon">
                                    <span>30% descuento</span>
                                </label>
                                <span>¡Te ahorras 9.120€!</span>
                            </div>
                            <div class="price-items">
                                <div class="box">
                                    <span class="medium">PVP Nuevo</span>
                                    <span class="small">año 2019</span>
                                    <span class="large">54.110€*</span>
                                </div>
                                <div class="box contrast">
                                    <span class="medium">Financiando</span>
                                    <span class="small">sujeto a financiación</span>
                                    <span class="large">44.990€*</span>
                                </div>
                                <div class="box">
                                    <span class="medium">Al contado</span>
                                    <span class="small">sin financiación</span>
                                    <span class="large">47.990€*</span>
                                </div>
                            </div>
                        </div>
                        <div class="sidebar__financing">
                            <span class="medium">Llévatelo financiado</span>
                            <div class="row">
                                <span class="small">desde 535€/mes*</span>
                                <a href="#vehicle-financing" class="vehicle-financing-calculator">Recalcular cuota</a>
                            </div>
                        </div>
                        <div class="sidebar__breakdown">
                            <div id="price-calculator" class="price-calculator" data-price="47990">
                                <div class="price-group">
                                    <div id="container2" class="price-group__entries"></div>
                                </div>
                                <div class="vehicle-price-result-container">
                                    <div id="vehicle-price-result" class="vehicle-price-result">
                                        <span class="entry__title">Precio Final</span>
                                        <span class="entry__amount">20.290€</span>
                                    </div>
                                    <div class="vehicle-price-result__text">
                                        <small>Todo incluido. Llave en mano.</small>
                                    </div>
                                    <div class="vehicle-price-result__action">
                                        <button class="btn btn-sm btn-footer" data-toggle="modal"
                                            data-target="[data-modal-vehicle-price-down]">
                                            <i class="fa-regular fa-bell-on"></i> Avísame si baja de precio
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Pay Details Section End -->
            </div>
            <div id="carInfoContainer">
                <div id="container" class="details-container"></div>
                <div class="section" id="carroceria"></div>
                <div class="section" id="motorYTransmision"></div>
                <div class="section" id="consumoYEmisiones"></div>
                <div class="section" id="garantiaContainer"></div>
                <div class="section" id="equipamiento"></div>
            </div>
        </div>
    </div>

    <script type="module">
import { preloadImages, showImage, showPrevImage, showNextImage, handleTouchStart, handleTouchEnd, renderThumbnails } from './imageFunctions.js';

document.addEventListener('DOMContentLoaded', async () => {
    const state = {
        currentImageIndex: 0,
        thumbnailStartIndex: 0,
        thumbnailCount: 4,
        imageUrls: [],
        carReference: getQueryParameter('id'),
        carData: null
    };

    if (!state.carReference) {
        document.getElementById('carDetailsContainer').innerHTML = '<p>No car reference provided.</p>';
        return;
    }

    await loadHeader();
    state.carData = await fetchCarDetails();

    if (state.carData) {
        state.imageUrls = Array.from({ length: state.carData.JavaScriptInfo.cantidadImágenes || 5 }, (_, i) => `listings/${state.carReference}/images/${i + 1}.webp`);
        preloadImages(state.imageUrls);
        renderCarDetails(state.carData);
        setupEventListeners(state);
    }

    async function loadHeader() {
        const response = await fetch('header.html');
        document.getElementById('header-container').innerHTML = await response.text();
    }

    async function fetchCarDetails() {
        try {
            const response = await fetch(`listings/${state.carReference}/data.json`);
            if (!response.ok) throw new Error(`Failed to fetch car details: ${response.status} ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error('Error fetching car details:', error);
            return null;
        }
    }

    function getQueryParameter(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function setupEventListeners(state) {
        document.getElementById('prevImage').addEventListener('click', () => showPrevImage(state));
        document.getElementById('nextImage').addEventListener('click', () => showNextImage(state));
        const carImageContainer = document.getElementById('carImageContainer');
        carImageContainer.addEventListener('touchstart', (event) => handleTouchStart(event, state));
        carImageContainer.addEventListener('touchend', (event) => handleTouchEnd(event, state));
        document.querySelectorAll('.navButton').forEach(button => {
            button.addEventListener('mouseenter', () => button.style.opacity = 0.8);
            button.addEventListener('mouseleave', () => button.style.opacity = 0.4);
        });
    }

    function renderCarDetails(car) {
        document.title = `${car.CaracteristicasGenerales.Marca} ${car.CaracteristicasGenerales.Modelo} ${car.CaracteristicasGenerales.Versión} ${car.MotorYTransmision.Combustible.Tipo} - ${car.CaracteristicasGenerales.Color} ${car.Carroceria.Tipo} (${car.Carroceria.Puertas}p)`;
        document.getElementById('carTitle').textContent = document.title;

        const carImage = document.getElementById('carImage');
        carImage.src = state.imageUrls[state.currentImageIndex];
        carImage.alt = `${car.CaracteristicasGenerales.Marca} ${car.CaracteristicasGenerales.Modelo} ${car.CaracteristicasGenerales.Año}`;

        const photoCountLabel = document.getElementById('photoCountLabel');
        photoCountLabel.innerHTML = `<img src="icons/photo-count.svg" alt="Info Icon" width="16" height="16">${state.currentImageIndex + 1} of ${state.imageUrls.length}`;

        document.getElementById('overview').innerHTML = `
            ${car.CaracteristicasGenerales.Año} | ${car.MotorYTransmision.Transmision.Caja} | ${car.CaracteristicasGenerales.Kilometraje} km ${car.MotorYTransmision.Combustible.Tipo} | ${car.MotorYTransmision.Potencia.KW} kW (${car.MotorYTransmision.Potencia.KW} CV)
        `;

        document.getElementById('garantiaContainer').innerHTML = `
            <h2>Garantía</h2>
            <p>${car.Garantía.Descripción}</p>
            <p>Garantía Estándar: ${car.Garantía.GarantíaEstándar} año(s)</p>
            <p>Garantía VIP: ${car.Garantía.GarantíaVIP} año(s)</p>
        `;

        document.getElementById('equipamiento').innerHTML = `
            <h2>Equipamiento</h2>
            <h3>Exterior</h3>
            <ul>${car.Equipamiento.Exterior.map(item => `<li>${item}</li>`).join('')}</ul>
            <h3>Interior</h3>
            <ul>${car.Equipamiento.Interior.map(item => `<li>${item}</li>`).join('')}</ul>
        `;

        // Call the new renderThumbnails function
        renderThumbnails(
            'thumbnailContainer',
            state.imageUrls,
            car,
            state.currentImageIndex,
            state.thumbnailStartIndex,
            state.thumbnailCount,
            (index) => showImage(index, state)
        );
    }

    function createCheckboxDiv(containerId, inputValue, inputStatus, entryText, entryID, entryValue, isLink = false, isDropdown = false) {
        const container = document.getElementById(containerId);
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'price-group__entry checkbox-wrapper';

        let innerHTML = `<input type="checkbox" id="${inputValue}" ${inputStatus}>`;
        innerHTML += `<label for="${inputValue}"></label>`;
        innerHTML += `<span class="entry__title">${entryText}</span>`;

        if (isLink) {
            innerHTML += `<span class="entry__amount"><a href="${entryValue}" rel="nofollow">Valorar mi vehículo</a></span>`;
        } else if (isDropdown) {
            innerHTML += `<select id="regionDropdown" style="display: none;"></select>`;
            innerHTML += `<span class="entry__amount" id="regionAmount">${entryValue}</span>`;
        } else {
            innerHTML += `<span class="entry__amount" id="${entryID}">${entryValue}</span>`;
        }

        checkboxDiv.innerHTML = innerHTML;
        container.appendChild(checkboxDiv);
    }

    function createDetailDiv(containerId, icon, detailValue, detailTitle, moreInfoText) {
        const container = document.getElementById(containerId);
        const moreDetailsDiv = document.createElement('div');
        moreDetailsDiv.className = 'more-details';

        moreDetailsDiv.innerHTML = `
            <img src="icons/details/${icon}.svg" alt="${detailTitle}" width="48" height="48">
            <div class="detail-text">
                <span class="detail-result">${detailValue}</span>
                <span class="detail-title">${detailTitle}</span>
                ${moreInfoText ? `<label class="more-information"><img src="icons/more-information.svg" alt="More information" width="12" height="12">${moreInfoText}</label>` : ''}
            </div>
        `;

        container.appendChild(moreDetailsDiv);
    }

    fetchCarDetails().then(carData => {
        if (carData) {
            createCheckboxDiv('container2', 'financeCheckbox', 'checked', 'Descuento por financiación', 'financeAmount', '-3.000€');
            createCheckboxDiv('container2', 'warrantyCheckbox', 'checked disabled', 'Garantía nacional de 12 meses', '', '0€');
            createCheckboxDiv('container2', 'exchangeCheckbox', 'disabled', 'Entrega vehículo a cambio', '', '/vender-mi-coche-a-cambio', true);
            createCheckboxDiv('container2', 'deliveryCheckbox', '', 'Entrega a domicilio', 'deliveryLabel', 'Activar', false, true);

            createDetailDiv('container', 'kilometres', `${new Intl.NumberFormat('es-ES').format(carData.CaracteristicasGenerales.Kilometraje)} km`, 'Kilometres');
            createDetailDiv('container', 'horsepower', `${carData.MotorYTransmision.Potencia.CV} CV`, 'Horsepower');
            createDetailDiv('container', 'fuel', carData.MotorYTransmision.Combustible.Tipo, 'Fuel Type');
            createDetailDiv('container', 'transmission', carData.MotorYTransmision.Transmision.Caja, 'Transmission');
            createDetailDiv('container', 'gears', carData.MotorYTransmision.Transmision.Marchas, 'Nº Gears');
            createDetailDiv('container', 'registration', carData.CaracteristicasGenerales.Año, 'Car Registered');
            createDetailDiv('container', 'doors', carData.Carroceria.Puertas, 'Nº doors');
            createDetailDiv('container', 'seats', carData.Carroceria.Plazas, 'Nº Seats');
            createDetailDiv('container', 'colour', carData.CaracteristicasGenerales.Color, 'Colour Exterior');
            createDetailDiv('container', 'consumption', `${new Intl.NumberFormat('es-ES').format(carData.ConsumoYEmisiones.Consumo.Medio)} l/100`, 'Fuel Consumption', 'See All');
            createDetailDiv('container', 'emissions', `${carData.ConsumoYEmisiones.EmisionesCO2} g/km`, 'Emissions CO2', 'More Information');
        }
    });
});
    </script>
</body>

</html>

</html>
