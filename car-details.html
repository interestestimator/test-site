<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Details</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-checkbox.css">
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
</head>

<body>
    <div id="header-container"></div>
    <div class="car-listings">
        <div id="carDetailsContainer">
            <div id="carImageGallery">
                <div id="carTitle"></div>
                <div id="carImageContainer">
                    <img id="carImage" class="car-image" alt="Car Image">
                    <div class="navButtonContainer" id="navButtons">
                        <button class="navButton" id="prevImage">&lt;</button>
                        <button class="navButton" id="nextImage">&gt;</button>
                    </div>
                    <label id="photoCountLabel" class="photo-count-label">
                        <img src="icons/photo-count.svg" alt="Info Icon" width="16" height="16">
                    </label>
                </div>
                <div id="thumbnailContainer"></div>
            </div>

            <div id="carFinanceContainer">
                <div class="section" id="overview"></div>

                <!-- Pay Details Section Start -->
                <section class="pay-details-section">
                    <div class="sidebar">
                        <div class="sidebar__prices">
                            <div class="section" id="overview"></div>
                            <div class="sidebar__discount">
                                <label id="discountLabel" class="discount-label">
                                    <img src="icons/discount-icon.svg" width="18" height="18" alt="Discount Icon">
                                    <span>30% descuento</span>
                                </label>
                                <span>¡Te ahorras 9.120€!</span>
                            </div>
                            <div class="price-items">
                                <div class="box contrast">
                                    <span class="medium">Financiando</span>
                                    <span class="small">sujeto a financiación</span>
                                    <span id="precioFinacio" class="large"></span>
                                </div>
                                <div class="box">
                                    <span class="medium">Al contado</span>
                                    <span class="small">sin financiación</span>
                                    <span id="precioNuevo" class="large"></span>
                                </div>
                            </div>
                        </div>
                        <div class="sidebar__financing">
                            <span class="medium">Llévatelo financiado</span>
                            <div class="row">
                                <span id="pmtValue" class="small">desde 535€/mes*</span>
                                <a href="#vehicle-financing" class="vehicle-financing-calculator">Recalcular cuota</a>
                            </div>
                        </div>
                        <div class="sidebar__breakdown">
                            <div id="price-calculator" class="price-calculator" data-price="47990">
                                <div class="price-group">
                                    <div id="carFinanceOptionsContainer" class="price-group__entries"></div>
                                </div>
                                <div class="vehicle-price-result-container">
                                    <div id="vehicle-price-result" class="vehicle-price-result">
                                        <span class="entry__title">Precio Final</span>
                                        <span id="PrecioFinal" class="entry__amount"></span>
                                    </div>
                                    <div class="vehicle-price-result__text">
                                        <small>Todo incluido. Llave en mano.</small>
                                    </div>
                                    <div class="vehicle-price-result__action">
                                        <button class="btn btn-sm btn-footer" data-toggle="modal"
                                            data-target="[data-modal-vehicle-price-down]">
                                            <i class="fa-regular fa-bell-on"></i> Avísame si baja de precio
                                        </button>
                                    </div>
                                    <!-- Section to edit -->
                                    <div class="vehicle-sidebar__main-actions">
                                        <div class="list-grid list-grid--2 list-grid--gap-1">
                                                                    <a href="#" class="btn btn-primary-action" data-toggle="modal" data-target="[data-modal-vehicle-contact]">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="fa-light fa-envelope fs-2"></span>
                        
                                                        <span class="text-left">
                                                            Contactar<br>
                                                            Ahora
                                                        </span>
                        
                                                        <span class="fa-sharp fa-regular fa-arrow-right"></span>
                                                    </div>
                                                </a>
                                            
                                            <a href="#" class="btn btn-outline-primary-action" data-toggle="modal" data-target="[data-modal-vehicle-test-drive]">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="fa-light fa-steering-wheel fs-2"></span>
                        
                                                    <span class="text-left">
                                                        Pruébalo sin<br>
                                                        compromiso
                                                    </span>
                        
                                                    <span class="fa-sharp fa-regular fa-arrow-right"></span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>

                                    <div class="trust-message">
                                        <div class="trust-message__icon fa-solid fa-message-smile fa-flip-horizontal"></div>
                        
                                        <div class="trust-message__title">
                                            Incluído <u>GRATIS</u>
                                        </div>
                        
                                        <div class="trust-message__text">
                                            <ul class="list-vertical list-vertical--check pl-1 mb-0" style="--decorator-color: var(--color-primary-action)">
                                                <li>12 meses de garantía</li>
                                                <li>Costes de gestión y transferencia</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <p class="mt-3 mb-0 color--neutral-300">
                                        <small>
                                            * Precio válido salvo error tipográfico.
                                        </small>
                                    </p>

                                </div>

                                <div class="vehicle-sidebar__after mt-3">
                                    <div class="row">
                                        <div class="col-6 text-center">
                                            <a href="https://www.sibuscascoche.com/coches-ocasion/audi/a4/avant-advanced-35-tdi-110kw-s-tronic/print" title="Imprimir ficha" class="link-action" data-track-vehicle-event="" data-track-vehicle-event-category="ficha" data-track-vehicle-event-action="imprimir-ficha" data-track-vehicle-event-label="https://www.sibuscascoche.com/coches-ocasion/audi/a4/avant-advanced-35-tdi-110kw-s-tronic" rel="nofollow" target="_blank">
                                                <i class="fal fa-print"></i> Imprimir ficha
                                            </a>
                                        </div>
                            
                                        <div class="col-6 text-center">
                                            <a href="#" title="Enviar por email" class="link-action" data-toggle="modal" data-target="[data-modal-vehicle-send-to-friend]">
                                                <i class="fal fa-envelope"></i> Enviar por email
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <!-- Section to edit end-->
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Pay Details Section End -->
            </div>
            <div id="carInfoContainer">
                <div id="carOverviewContainer" class="details-container"></div>
                <!-- Section to edit -->
                <div class="text-center mt-4">
                    <p class="background-color--neutral-100 px-3 py-2 border-radius-3 d-inline-block">
                        <span class="color--primary-action font-italic">
                            <span class="fal fa-hashtag"></span> Referencia:
                        </span>
    
                        SIBUSCASCOCHE/VO/32165
                    </p>
                </div>
                <div class="text-center">
                    <a data-scroll="" href="#equipamiento" class="btn btn-outline-primary-action">
                        Ver equipamiento completo
                    </a>
                </div>
                <!-- Section to edit end-->

                <div class="section" id="carroceria"></div>
                <div class="section" id="motorYTransmision"></div>
                <div class="section" id="consumoYEmisiones"></div>
                <div class="section" id="garantiaContainer"></div>
                <div class="section" id="equipamiento"></div>
            </div>


            <!-- Section to edit -->
            <div id="vehicle-financing" class="vehicle-financing">
                <div class="container">
                    <div class="text-center mb-5">
                        <h2 class="title-basic color--base-white">
                            <strong><em>Financiación</em></strong>
                            100% sin entrada
                        </h2>
                        <p class="lead color--base-white">
                            Grandes descuentos por financiar con nosotros. ¡Descúbrelos!
                        </p>
                    </div>
            
                    <div id="vehicle-financing-calculator" 
                         data-bank="Banco asociado"
                         data-opening-commission="0.0395"
                         data-offer="3000"
                         data-deposit="5498"
                         data-price="21990"
                         data-minimum-amount="16492.5"
                         data-quota="262"
                         data-tables='{
                            "6": {"months": 72, "coefficient": 0.020734, "tin": 10.99, "tae": 13.2},
                            "7": {"months": 84, "coefficient": 0.01887, "tin": 10.99, "tae": 12.97},
                            "8": {"months": 96, "coefficient": 0.01754, "tin": 10.99, "tae": 12.82},
                            "9": {"months": 108, "coefficient": 0.016571, "tin": 10.99, "tae": 12.71},
                            "10": {"months": 120, "coefficient": 0.015862, "tin": 10.99, "tae": 12.63}
                         }'
                         data-disclaimer="
                            <p class='text-justify small mt-5 mb-0'>
                                Financiación lineal ofrecida por Sabadell, BBVA, CaixaBank, ABANCA, Santander o Cetelem según campaña vigente,
                                sometida a su estudio y aprobación. Esta simulación ha sido obtenida a partir del plazo e importe que hayas
                                definido. Las condiciones económicas se actualizarán en cada simulación.
                                Oferta válida hasta el 14/08/2024.
                                TIN {financing.tinFormatted}%. TAE {financing.taeFormatted}%. La cuotas incluyen comisión de apertura y seguro de protección de pago.
                                El importe total financiado es {financing.amountFormatted}€ + comisión de apertura {financing.openingCommissionAmountFormatted}€ + seguro pp (consultar).
                                Plazo de la financiación {financing.monthsFormatted} meses. {financing.monthsFormatted} cuotas de {financing.quotaFormatted}€.
                                Entrada inicial: {financing.depositFormatted}€.
                                Importe Total adeudado: {financing.totalDebtFormatted}€ (intereses {financing.totalInterestFormatted}€).
                                Los cálculos facilitados en cada simulación tienen una finalidad informativa y no sustituye a las condiciones
                                finales del contrato de financiación si este fuera concedido.
                            </p>
                         "
                         class="vehicle-financing__calculator">
                        <div class="financing-calculator">
                            <div class="financing-calculator__controls">
                                <div class="financing-calculator__amount">
                                    <span class="label">Cantidad a financiar
                                        <span class="financing-calculator__label-info"
                                              data-tooltip-id="financing-calculator-tooltip"
                                              data-tooltip-content="Cantidad a financiar = PVP - descuentos - entrada inicial"
                                              data-tooltip-place="top"></span>
                                    </span>
                                    <span class="value">18.990<span class="symbol">€</span></span>
                                </div>
                                <div class="financing-calculator__deposit">
                                    <p>
                                        <span class="label">Entrada inicial</span>
                                        <input type="text" inputmode="decimal" name="deposit" class="form-control" placeholder="0" value="3.000&nbsp;€">
                                        <small class="ml-2 font-italic text-muted">Máxima: 5.498<span class="symbol">€</span></small>
                                    </p>
                                    <div class="financing-calculator__slider" id="deposit">
                                        <div class="slider slider-horizontal">
                                            <div class="slider-track">
                                                <div class="slider-track-low" style="left: 0; width: 0%;"></div>
                                                <div class="slider-selection" style="left: 0%; width: 54.5752%;"></div>
                                                <div class="slider-track-high" style="right: 0; width: 45.4248%;"></div>
                                            </div>
                                            <div class="tooltip tooltip-main bs-tooltip-top hide" role="presentation" style="left: 54.5752%;">
                                                <div class="arrow"></div>
                                                <div class="tooltip-inner">3000</div>
                                            </div>
                                            <div class="slider-handle min-slider-handle round" role="slider" aria-valuemin="0" aria-valuemax="5497" aria-valuenow="3000" tabindex="0" style="left: 54.5752%;"></div>
                                            <div class="slider-handle max-slider-handle round hide" role="slider" aria-valuemin="0" aria-valuemax="5497" aria-valuenow="0" tabindex="0" style="left: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="financing-calculator__years">
                                    <p>
                                        <span class="label">Duración</span>
                                        <select class="form-control" name="years">
                                            <option value="6">6 años</option>
                                            <option value="7">7 años</option>
                                            <option value="8">8 años</option>
                                            <option value="9">9 años</option>
                                            <option value="10">10 años</option>
                                        </select>
                                    </p>
                                    <div class="financing-calculator__slider" id="years">
                                        <div class="slider slider-horizontal">
                                            <div class="slider-track">
                                                <div class="slider-track-low" style="left: 0; width: 0%;"></div>
                                                <div class="slider-selection" style="left: 0%; width: 75%;"></div>
                                                <div class="slider-track-high" style="right: 0; width: 25%;"></div>
                                            </div>
                                            <div class="tooltip tooltip-main bs-tooltip-top hide" role="presentation" style="left: 75%;">
                                                <div class="arrow"></div>
                                                <div class="tooltip-inner">9</div>
                                            </div>
                                            <div class="slider-handle min-slider-handle round" role="slider" aria-valuemin="6" aria-valuemax="10" aria-valuenow="9" tabindex="0" style="left: 75%;"></div>
                                            <div class="slider-handle max-slider-handle round hide" role="slider" aria-valuemin="6" aria-valuemax="10" aria-valuenow="6" tabindex="0" style="left: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="financing-calculator__quota">
                                    <button class="btn btn-block btn-primary btn-primary-action" data-toggle="modal" data-target="[data-modal-vehicle-financing]">
                                        <div>Quiero esta cuota</div>
                                        <div class="amount">315<span class="symbol">€/mes</span></div>
                                    </button>
                                </div>
                            </div>
                            <div class="financing-calculator__summary">
                                <p class="mb-1">Ofrecido por:</p>
                                <p><strong>Banco asociado</strong></p>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td><span class="label">Precio del coche (<strong>PVP</strong>)</span></td>
                                            <td><span class="amount">24.990<span class="symbol">€</span></span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label highlighted"><span class="fa-light fa-gift"></span> Bonificación por financiar</span></td>
                                            <td><span class="amount">-3.000<span class="symbol">€</span></span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label">Entrada inicial</span></td>
                                            <td><span class="amount">3.000<span class="symbol">€</span></span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label">Importe a financiar</span></td>
                                            <td><span class="amount">18.990<span class="symbol">€</span></span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label">TAE</span></td>
                                            <td><span class="amount">12.76<span class="symbol">%</span></span></td>
                                        </tr>
                                        <tr>
                                            <td><span class="label">TIN</span></td>
                                            <td><span class="amount">10.99<span class="symbol">%</span></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="mt-1 text-center">
                                    <button title="Documentos necesarios para financiar" class="btn btn-sm btn-outline-primary-inverse font-weight-bold" data-toggle="modal" data-target="[data-modal-vehicle-financing-documents]">
                                        <span class="fa-light fa-book"></span> Documentación necesaria
                                    </button>
                                </div>
                            </div>
                            <div class="financing-calculator__disclaimer">
                                <p class="text-justify small mt-5 mb-0">
                                    Financiación lineal ofrecida por Sabadell, BBVA, CaixaBank, ABANCA, Santander o Cetelem según campaña vigente,
                                    sometida a su estudio y aprobación. Esta simulación ha sido obtenida a partir del plazo e importe que hayas
                                    definido. Las condiciones económicas se actualizarán en cada simulación.
                                    Oferta válida hasta el 14/08/2024.
                                    TIN 10,99%. TAE 12,76%. La cuotas incluyen comisión de apertura y seguro de protección de pago.
                                    El importe total financiado es 18.990€ + comisión de apertura 750,11€ + seguro pp (consultar).
                                    Plazo de la financiación  meses.  cuotas de 315€.
                                    Entrada inicial: 3.000€.
                                    Importe Total adeudado: 34.020€ (intereses 14.279,90€).
                                    Los cálculos facilitados en cada simulación tienen una finalidad informativa y no sustituye a las condiciones
                                    finales del contrato de financiación si este fuera concedido.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Section to edit end-->

            <div id="companyAdvantagesContainer" class="details-container"></div>

            
        </div>
        
    </div>
    <footer id="footer" class="footer bg-dark text-light py-4" style="background-color: #343a40; color: #f8f9fa;">
    
        <div class="container">
            <div class="row">
                <!-- Company Info -->
                <div class="col-md-3">
                    <h5 class="footer-title">Company</h5>
                    <ul class="list-unstyled">
                        <li><a href="/about" class="text-light">About Us</a></li>
                        <li><a href="/careers" class="text-light">Careers</a></li>
                        <li><a href="/blog" class="text-light">Blog</a></li>
                        <li><a href="/contact" class="text-light">Contact Us</a></li>
                    </ul>
                </div>
    
                <!-- Customer Service -->
                <div class="col-md-3">
                    <h5 class="footer-title">Customer Service</h5>
                    <ul class="list-unstyled">
                        <li><a href="/faq" class="text-light">FAQ</a></li>
                        <li><a href="/returns" class="text-light">Returns</a></li>
                        <li><a href="/shipping" class="text-light">Shipping Information</a></li>
                        <li><a href="/terms" class="text-light">Terms & Conditions</a></li>
                    </ul>
                </div>
    
                <!-- Social Media -->
                <div class="col-md-3">
                    <h5 class="footer-title">Follow Us</h5>
                    <div class="social-media">
                        <a href="https://facebook.com" class="text-light me-2" aria-label="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://twitter.com" class="text-light me-2" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://instagram.com" class="text-light me-2" aria-label="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://linkedin.com" class="text-light" aria-label="LinkedIn">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                    </div>
                </div>
    
                <!-- Contact Information -->
                <div class="col-md-3">
                    <h5 class="footer-title">Contact Information</h5>
                    <address>
                        <p><i class="fas fa-map-marker-alt"></i> 123 Main Street, Anytown, USA</p>
                        <p><i class="fas fa-phone"></i> +1 234 567 890</p>
                        <p><i class="fas fa-envelope"></i> <a href="mailto:info@example.com" class="text-light">info@example.com</a></p>
                    </address>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="mb-0">&copy; 2024 Your Company Name. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>

<script type="module">
    import { preloadImages, showImage, showPrevImage, showNextImage, handleTouchStart, handleTouchEnd } from './imageFunctions.js';
    import { setLoanParameters, calculateRate, formatCurrency } from './loanCalculator.js';

    document.addEventListener('DOMContentLoaded', async () => {
        const state = initializeState();
        const elements = initializeElements();

        if (!state.carReference) {
            elements.carDetailsContainer.innerHTML = '<p>No car reference provided.</p>';
            return;
        }

        await loadHeader(elements.headerContainer);
        state.carData = await fetchData(`listings/${state.carReference}/data.json`);

        if (state.carData) {
            setupStateImages(state, state.carData.JavaScriptInfo.cantidadImágenes);
            preloadImages(state.imageUrls, state, elements.thumbnailContainer);
            setupEventListeners(state, elements);
            renderCarDetails(state, elements);

        }

        if (state.carData) {
            setupOtherListeners(state);
        }


        const {
            JavaScriptInfo: { id: carId, cantidadImágenes: imageCount, estado: availability },
            CaracteristicasGenerales: { PrecioNuevo: price, Año: year, Kilometraje: rawKilometres, Marca: brand, Modelo: model, Versión: version, Color: color, PrecioAnterior: previousPrice },
            MotorYTransmision: { Combustible: { Tipo: fuelType }, Transmision: { Caja: transmissionType, Marchas: gears }, Potencia: { KW: powerKW, CV: powerCV }, Rendimiento: { Aceleración: acceleration, VelocidadMáxima: topSpeed } },
            Carroceria: { Tipo: bodyType, Puertas: doors, Plazas: seats, Dimensiones: { Largo: length, Ancho: width, Alto: height } },
            ConsumoYEmisiones: { Etiqueta: emissionLabel, EmisionesCO2: co2Emissions, Depósito: fuelTankCapacity, Consumo: { Medio: rawAverageConsumption, Urbano: urbanConsumption, Carretera: highwayConsumption } },
            Garantía: { Descripción: warrantyDescription, GarantíaEstándar: standardWarranty, GarantíaVIP: vipWarranty },
            Financiando: financingDetails,
            Descripción: carDescription,
            Equipamiento: { Exterior: exteriorEquipment, Interior: interiorEquipment },
            Multimedia: multimediaFeatures,
            Seguridad: safetyFeatures,
            Otros: otherFeatures
        } = state.carData;

        // Utility function for number formatting
        const formatNumber = (number, locale = 'es-ES') => new Intl.NumberFormat(locale).format(number);

        // Format kilometres and average consumption using the utility function
        const kilometres = formatNumber(rawKilometres);
        const averageConsumption = formatNumber(rawAverageConsumption);

        function setupOtherListeners(state) {

            // Set up MutationObserver to watch for dynamically added checkboxes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length) {
                        const financeCheckbox = document.getElementById('financeCheckbox');
                        const deliveryCheckbox = document.getElementById('deliveryCheckbox');

                        if (financeCheckbox) {
                            financeCheckbox.addEventListener('change', (event) => handleFinanceCheckboxChange(event));
                        }

                        if (deliveryCheckbox) {
                            deliveryCheckbox.addEventListener('change', async (event) => {
                                await handleDeliveryCheckboxChange(event);
                            });
                        }
                    }
                });
            });

            observer.observe(elements.carFinanceOptionsContainer, { childList: true });

            async function handleDeliveryCheckboxChange(event) {
                const regionDropdown = document.getElementById('regionDropdown');
                const regionAmount = document.getElementById('regionAmount');
                const regionTitle = document.getElementById('deliveryLabel_title'); // Select the title element
                const vehiclePriceResult = document.querySelector('.vehicle-price-result'); // Select the element to animate

                if (event.target.checked) {
                    // Show the dropdown
                    regionDropdown.style.display = 'block';
                    regionTitle.textContent = 'Seleccionar:'; // Update text to "Seleccionar:" when dropdown is visible

                    // Populate dropdown with options
                    const deliveryRegions = await fetchData('deliveryRegions.json');
                    populateDropdown(regionDropdown, deliveryRegions);

                    // Automatically select the first value and update regionAmount
                    if (deliveryRegions.length > 0) {
                        regionDropdown.value = deliveryRegions[0].value; // Select the first value
                        updateRegionAmount(deliveryRegions[0].value, deliveryRegions);
                        updatePrices(); // Ensure prices are updated after setting initial value
                    }

                    // Add event listener for dropdown change
                    regionDropdown.addEventListener('change', (event) => {
                        const selectedValue = event.target.value;
                        updateRegionAmount(selectedValue, deliveryRegions);
                        updatePrices(); // Update prices whenever the selection changes
                    });
                } else {
                    // Hide the dropdown
                    regionDropdown.style.display = 'none';
                    regionTitle.textContent = 'Entrega a domicilio'; // Revert text to "Entrega a domicilio" when dropdown is hidden
                    regionAmount.textContent = 'Activar'; // Reset regionAmount text
                    regionDropdown.value = ''; // Reset dropdown value
                    state.deliveryCost = 0; // Reset delivery cost
                    updatePrices(); // Update prices whenever delivery checkbox is unchecked
                }
            }

            function handleFinanceCheckboxChange(event) {
                // Set financeCost to FINANCIO_DESCUBIENTO when unchecked, or to 0 when checked
                state.financeCost = event.target.checked ? 0 : state.FINANCIO_DESCUBIENTO;
                updatePrices(); // Update prices whenever finance checkbox state changes
            }

            function populateDropdown(dropdown, regions) {
                dropdown.innerHTML = ''; // Clear existing options
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.value;
                    option.textContent = region.label;
                    dropdown.appendChild(option);
                });

                // Set default text when no option is selected
                const regionAmount = document.getElementById('regionAmount');
                regionAmount.textContent = 'Seleccionar:'; // Default text when dropdown is visible but no option selected
            }

            function updateRegionAmount(selectedValue, regions) {
                const regionAmount = document.getElementById('regionAmount');
                const selectedRegion = regions.find(region => region.value == selectedValue);

                if (selectedRegion) {
                    if (selectedRegion.value === "CONSULTAR") {
                        regionAmount.textContent = 'Consultar'; // Display "Consultar" when value is "CONSULTAR"
                        state.deliveryCost = 0; // Set delivery cost to 0 if value is "CONSULTAR"
                    } else {
                        regionAmount.textContent = `${formatCurrency(selectedRegion.value)}`;
                        state.deliveryCost = parseFloat(selectedRegion.value) || 0; // Convert value to number or set to 0 if invalid
                    }
                } else {
                    regionAmount.textContent = '0'; // Default to '0' if no valid region is selected
                    state.deliveryCost = 0; // Reset delivery cost if no valid region is selected
                }
            }

            function updatePrices() {
                if (state.carData) {
                    state.FINANCIO_DESCUBIENTO = price * 0.1;

                    const deliveryCost = state.deliveryCost || 0;
                    const financeCost = state.financeCost || 0;
                    const PrecioFinal = (price - state.FINANCIO_DESCUBIENTO) + deliveryCost + financeCost;

                    if (elements.precioNuevo && elements.PrecioFinal) {
                        elements.precioNuevo.textContent = `${formatCurrency(price)}*`;
                        elements.PrecioFinal.textContent = `${formatCurrency(PrecioFinal)}*`;
                    }
                }
            }
        }

        function renderCarDetails(state, elements) {
            const {
                JavaScriptInfo: { id: carId, cantidadImágenes: imageCount },
                CaracteristicasGenerales: { PrecioNuevo: price, Año: year, Kilometraje: rawKilometres, Marca: brand, Modelo: model, Versión: version, Color: color },
                MotorYTransmision: { Combustible: { Tipo: fuelType }, Transmision: { Caja: transmissionType, Marchas: gears }, Potencia: { KW: powerKW, CV: powerCV } },
                Carroceria: { Tipo: bodyType, Puertas: doors, Plazas: seats },
                ConsumoYEmisiones: { Etiqueta: emissionLabel, EmisionesCO2: co2Emissions, Consumo: { Medio: rawAverageConsumption } },
                Garantía: { Descripción: warrantyDescription, GarantíaEstándar: standardWarranty, GarantíaVIP: vipWarranty },
                Equipamiento: { Exterior: exteriorEquipment, Interior: interiorEquipment },
                Multimedia: multimediaFeatures,
                Seguridad: safetyFeatures,
                Otros: otherFeatures
            } = state.carData;

            const formatNumber = (number, locale = 'es-ES') => new Intl.NumberFormat(locale).format(number);
            const kilometres = formatNumber(rawKilometres);
            const averageConsumption = formatNumber(rawAverageConsumption);

            elements.carTitle.textContent = `${year} ${brand} ${model} ${version} ${fuelType} - ${color} ${bodyType} (${doors}p)`;
            elements.carImage.src = state.imageUrls[0];
            elements.photoCountLabel.innerHTML = `<img src="icons/photo-count.svg" alt="Info Icon" width="16" height="16">${state.currentImageIndex + 1}/${imageCount}`;
            elements.overview.innerHTML = `${year} | ${transmissionType} | ${kilometres} km ${fuelType} | ${powerKW} kW (${powerCV} CV)` || 'Descripción no disponible';
            elements.garantiaContainer.innerHTML = renderWarranty(warrantyDescription, standardWarranty, vipWarranty);

            const dropdownContainer = document.getElementById('equipamiento');
            dropdownContainer.innerHTML = `
            <div class="dropdown-container">
                <h2 class="container-title">Car Features</h2>
                ${createDropdown('Exterior', 'exteriorContent', exteriorEquipment)}
                ${createDropdown('Interior', 'interiorContent', interiorEquipment)}
                ${createDropdown('Multimedia', 'multimediaContent', multimediaFeatures)}
                ${createDropdown('Seguridad', 'seguridadContent', safetyFeatures)}
            </div>
        `;

            document.querySelectorAll('.dropdown-title').forEach(title => {
                title.addEventListener('click', toggleDropdown);
            });

            document.getElementById('exteriorContent').classList.add('show');
            document.querySelector('.dropdown-title img').src = 'icon-open.svg';

            const vehicleDeposit = price * 0.1;
            const { annualRateTIN, loanLengthMonths, commissionRate } = setLoanParameters(price, year, kilometres);

            const result = calculateRate(
                loanLengthMonths / 12, // Convert months to years
                price, // Total price
                vehicleDeposit, // Initial deposit
                annualRateTIN / 100, // Convert annual rate from percentage
                commissionRate / 100, // Convert commission rate from percentage
                0.0 // No additional fees
            );

            const precioFinacio = price - vehicleDeposit;
            const formattedValues = {
                precioNuevo: formatCurrency(price),
                financioDescubiento: formatCurrency(vehicleDeposit),
                precioFinacio: formatCurrency(precioFinacio),
                pmt: formatCurrency(Math.abs(result.pmt))
            };

            updateElementText(elements.pmtValue, formattedValues.pmt, 'desde ');
            updateElementText(elements.financeAmount, formattedValues.financioDescubiento, '-');
            updateElementText(elements.precioNuevo, formattedValues.precioNuevo);
            updateElementText(elements.precioFinacio, formattedValues.precioFinacio);
            updateElementText(elements.PrecioFinal, formattedValues.precioFinacio);
        }

        // Initialize checkboxes and detail divs
        createCheckboxDiv('carFinanceOptionsContainer', 'financeCheckbox', 'checked', 'Descuento por financiación', 'financeAmount', `-${formatCurrency(price * 0.1)}*`);
        createCheckboxDiv('carFinanceOptionsContainer', 'warrantyCheckbox', 'checked disabled', 'Garantía nacional de 12 meses', '', '0 €');
        createCheckboxDiv('carFinanceOptionsContainer', 'exchangeCheckbox', 'disabled', 'Entrega vehículo a cambio', '', '/vender-mi-coche-a-cambio', true);
        createCheckboxDiv('carFinanceOptionsContainer', 'deliveryCheckbox', '', 'Entrega a domicilio', 'deliveryLabel', 'Activar', false, true);

        createDetailDiv('carOverviewContainer', 'kilometres', `${kilometres} km`, 'Kilometres');
        createDetailDiv('carOverviewContainer', 'horsepower', `${powerCV} CV`, 'Horsepower');
        createDetailDiv('carOverviewContainer', 'fuel', fuelType, 'Fuel Type');
        createDetailDiv('carOverviewContainer', 'transmission', transmissionType, 'Transmission');
        createDetailDiv('carOverviewContainer', 'gears', gears, 'Nº Gears');
        createDetailDiv('carOverviewContainer', 'registration', year, 'Car Registered');
        createDetailDiv('carOverviewContainer', 'doors', doors, 'Nº doors');
        createDetailDiv('carOverviewContainer', 'seats', seats, 'Nº Seats');
        createDetailDiv('carOverviewContainer', 'colour', color, 'Colour Exterior');
        createDetailDiv('carOverviewContainer', 'consumption', `${averageConsumption} l/100`, 'Fuel Consumption', 'See All');
        createDetailDiv('carOverviewContainer', 'emissions', `${co2Emissions} g/km`, 'Emissions CO2', 'More Information');


        createDetailDiv('companyAdvantagesContainer', 'emissions', `Vehículos revisados`, 'Revisión de 250 puntos revisados por nuestro equipo de profesionales.');
        createDetailDiv('companyAdvantagesContainer', 'emissions', `Kilometraje garantizado`, 'Somos transparentes. Compra tu coche con certificado de kilómetros reales.');
        createDetailDiv('companyAdvantagesContainer', 'emissions', `Garantía de 12 meses`, 'Este vehículo dispone de una garantía de 12 meses.');
        createDetailDiv('companyAdvantagesContainer', 'emissions', `Envío a domicilio`, 'Sin desplazamientos, te lo llevamos a casa. Antes de lo que crees, lo tendrás en tus manos.');
        createDetailDiv('companyAdvantagesContainer', 'emissions', `Aceptamos tu coche como parte del pago`, 'Te ofrecemos las tasaciones más competitivas del mercado.');
        createDetailDiv('companyAdvantagesContainer', 'emissions', `Pruébalo sin compromiso`, 'Dispones de 15 días o 1.000 km para probar el vehículo. Si no te convence, cámbialo por otro.');
    });

    // Initialize State
    function initializeState() {
        return {
            currentImageIndex: 0,
            thumbnailStartIndex: 0,
            thumbnailCount: 4,
            imageUrls: [],
            carReference: getQueryParameter('id'),
            carData: null,
            deliveryCost: 0,
            financeCost: 0,
            FINANCIO_DESCUBIENTO: 0,
        };
    }

    // Initialize DOM Elements
    function initializeElements() {
        return {
            carDetailsContainer: document.getElementById('carDetailsContainer'),
            headerContainer: document.getElementById('header-container'),
            carImageContainer: document.getElementById('carImageContainer'),
            prevImage: document.getElementById('prevImage'),
            nextImage: document.getElementById('nextImage'),
            regionDropdown: document.getElementById('regionDropdown'),
            regionAmount: document.getElementById('regionAmount'),
            deliveryLabelTitle: document.getElementById('deliveryLabel_title'),
            carFinanceOptionsContainer: document.getElementById('carFinanceOptionsContainer'),
            precioNuevo: document.getElementById('precioNuevo'),
            PrecioFinal: document.getElementById('PrecioFinal'),
            carTitle: document.getElementById('carTitle'),
            carImage: document.getElementById('carImage'),
            photoCountLabel: document.getElementById('photoCountLabel'),
            overview: document.getElementById('overview'),
            garantiaContainer: document.getElementById('garantiaContainer'),
            equipamiento: document.getElementById('equipamiento'),
            pmtValue: document.getElementById('pmtValue'),
            financeAmount: document.getElementById('financeAmount'),
            precioFinacio: document.getElementById('precioFinacio'),
            thumbnailContainer: document.getElementById('thumbnailContainer')
        };
    }

    // Load Header
    async function loadHeader(headerContainer) {
        try {
            const response = await fetch('header.html');
            headerContainer.innerHTML = await response.text();
        } catch (error) {
            console.error('Error loading header:', error);
        }
    }

    // Fetch Data
    async function fetchData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to fetch data from ${url}: ${response.status} ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error('Error fetching data:', error);
            return null;
        }
    }

    // Get Query Parameter
    function getQueryParameter(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    // Setup Image URLs
    function setupStateImages(state, imageCount) {
        state.imageUrls = Array.from({ length: imageCount || 5 }, (_, i) => `listings/${state.carReference}/images/${i + 1}.webp`);
    }

    // Setup Event Listeners
    function setupEventListeners(state, elements) {
        if (elements.prevImage) {
            elements.prevImage.addEventListener('click', () => showPrevImage(state, elements.carImage, elements.photoCountLabel));
        }
        if (elements.nextImage) {
            elements.nextImage.addEventListener('click', () => showNextImage(state, elements.carImage, elements.photoCountLabel));
        }
        if (elements.carImageContainer) {
            elements.carImageContainer.addEventListener('touchstart', (event) => handleTouchStart(event, state));
            elements.carImageContainer.addEventListener('touchend', (event) => handleTouchEnd(event, state, elements.carImage, elements.photoCountLabel));
        }
        document.querySelectorAll('.navButton').forEach(button => {
            button.addEventListener('mouseenter', () => button.style.opacity = 0.8);
            button.addEventListener('mouseleave', () => button.style.opacity = 0.4);
        });
    }

    function createDetailDiv(containerId, icon, detailValue, detailTitle, moreInfoText) {
        const container = document.getElementById(containerId);
        const moreDetailsDiv = document.createElement('div');
        moreDetailsDiv.className = 'more-details';

        moreDetailsDiv.innerHTML = `
            <img src="icons/details/${icon}.svg" alt="${detailTitle}" width="48" height="48">
            <div class="detail-text">
                <span class="detail-result">${detailValue}</span>
                <span class="detail-title">${detailTitle}</span>
                ${moreInfoText ? `<label class="more-information"><img src="icons/more-information.svg" alt="More information" width="12" height="12">${moreInfoText}</label>` : ''}
            </div>
        `;

        container.appendChild(moreDetailsDiv);
    }

    function createCheckboxDiv(containerId, inputValue, inputStatus, entryText, entryID, entryValue, isLink = false, isDropdown = false) {
        const container = document.getElementById(containerId);
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'price-group__entry checkbox-wrapper';

        let innerHTML = `<input type="checkbox" id="${inputValue}" ${inputStatus}>`;
        innerHTML += `<label for="${inputValue}"></label>`;
        innerHTML += `<span id="${entryID}_title" class="entry__title">${entryText}</span>`;

        if (isLink) {
            innerHTML += `<span class="entry__amount"><a href="${entryValue}" rel="nofollow">Valorar mi vehículo</a></span>`;
        } else if (isDropdown) {
            innerHTML += `<select id="regionDropdown" style="display: none;"></select>`;
            innerHTML += `<span class="entry__amount" id="regionAmount">${entryValue}</span>`;
        } else {
            innerHTML += `<span class="entry__amount" id="${entryID}">${entryValue}</span>`;
        }

        checkboxDiv.innerHTML = innerHTML;
        container.appendChild(checkboxDiv);
    }

    function updateElementText(element, value, prefix = '') {
        if (element) {
            element.textContent = `${prefix}${value}*`;
        }
    }

    // Function to handle dropdown toggling
    function toggleDropdown(event) {
        const targetId = event.target.closest('.dropdown-title').getAttribute('data-target');
        const targetElement = document.getElementById(targetId);
        const titleElement = event.target.closest('.dropdown-title');
        const imgElement = titleElement.querySelector('img');

        // Hide all dropdown contents and reset icons
        document.querySelectorAll('.dropdown-content2').forEach(content => {
            if (content !== targetElement) {
                content.classList.remove('show');
            }
        });

        document.querySelectorAll('.dropdown-title img').forEach(img => {
            if (img !== imgElement) {
                img.src = 'icon-closed.svg';
            }
        });

        // Toggle the clicked dropdown content and update icon
        const isOpen = targetElement.classList.toggle('show');
        imgElement.src = isOpen ? 'icon-open.svg' : 'icon-closed.svg';
    }

    function createDropdown(title, targetId, items) {
        return `
            <div class="dropdown">
                <label class="dropdown-title" data-target="${targetId}">
                    ${title}
                    <img src="icon-closed.svg" alt="Dropdown Icon">
                </label>
                <div id="${targetId}" class="dropdown-content2">
                    <ul class="custom-list">${items.map(item => `<li>${item}</li>`).join('')}</ul>
                </div>
            </div>
        `;
    }

    function renderWarranty(description, standard, vip) {
        return `<h3>Garantía</h3><p>${description || 'Descripción no disponible'}</p><ul>
            <li>Estándar: ${standard || 'No disponible'}</li>
            <li>VIP: ${vip || 'No disponible'}</li></ul>
        `;
    }
</script>

</html>
